'use strict';!function(require,directRequire){async function a(a,d={}){return new Promise(async(e,k)=>{let l=await j(a);if(!d.node_modules&&!d.src){let a=new Error;return a.code=s,a.message=`请选择需要上传的代码。错误：${s}`,k(a)}if(!l.svr){let a=new Error;return a.code=p,a.message=`未找到 project.config.json 中的 svr 字段。错误：${p}`,k(a)}let m={},n=Date.now(),o=`${a.appid}_${Date.now()}_qcloud.wx`,q=f.join(t,o),r=[];if(d.node_modules||r.push(f.join(l.svr,'node_modules/**/*')),d.packagejson||r.push(f.join(l.svr,'package.json')),!d.src){let a=h.readdirSync(l.svr);a.forEach((a)=>{if('node_modules'!==a&&'.'!==a&&'package.json'!==a){let b=h.lstatSync(f.join(l.svr,a));b.isDirectory()?r.push(f.join(l.svr,`${a}/**/*`)):r.push(f.join(l.svr,`${a}`))}})}let{destPath:u,data:v}=await i(l.svr,q,{ignore:r,cwd:l.svr});m.packTime=Date.now()-n;let w=Date.now(),x=g.gzipSync(v);m.zilbTime=Date.now()-w,m.dataLength=v.length,m.pDataLength=x.length;try{let a=await b();d.onBeforeUpload&&d.onBeforeUpload(m);let{host:f,url:g,sign:h}=a.body;g=`http://${f}${g}/${o}`;let i=Date.now(),j=await c(g,h,x);m.upLoadTime=Date.now()-i,j=JSON.parse(j.body),0===j.code?e({destPath:u,ext:m,upCosRes:j,sign:h,host:f,url:g,fileName:o}):k(`UP TO COS ERROR: code: ${j.code} ${j.message}`)}catch(a){k(a)}})}async function b(){return new Promise(async(a,b)=>{try{let b=await k({url:m,method:'post',needToken:1,needAppID:1});return console.log('getCosInfo:',b.body),a(b)}catch(a){console.error('getCosInfo:',a),b(a)}})}async function c(a,b,c){return new Promise(async(d,f)=>{try{let e=await k({url:a,needToken:-1,needParse:-1,method:'POST',proxy:'http://dev-proxy.oa.com:8080',headers:{Authorization:b},formData:{op:'upload',filecontent:c}});console.log(`upToCos: fileDataLength: ${c.length} resBody:`,e.body),d(e)}catch(a){console.error('upToCos:',a),f(a)}})}async function d(a){let b=a.env||l.CLOUD_ENV_DEVLOPE,c=a.action,d=a.fileName||'';return new Promise(async(f,g)=>{if(u[c]){let a=new Error;return a.code=r,console.error(`operatecvm: ${c}, QCLOUD_SVR_POLL_DOING`),g(a)}u[c]=!0;try{let h=await k({url:n,method:'post',needToken:1,needAppID:1,body:JSON.stringify({action:c,env:b,filename:d})});console.log(`operatecvm: action: ${c}; env: ${b}; resBody:`,h.body),a.beforePoll&&a.beforePoll();let i=h.body.event_uuid,j=await e({uuid:i});return j=JSON.parse(j.body.resp_data),u[c]=!1,0===j.code?f(j):g(j)}catch(a){u[c]=!1,console.error(`operatecvm: action: ${c}; env: ${b}; error:`,a),g(a)}})}async function e(a){async function b(c,d){a.beiginTime||(a.beiginTime=Date.now());let e=a.uuid;if(Date.now()-a.beiginTime>l.POLL_MAX_TIME){let a=new Error;return a.code=q,console.error(`polleventresp: event_uuid: ${e}, QCLOUD_SVR_POLL_TIMEOUT`),d(a)}try{let a=await k({url:o,method:'post',needToken:1,needAppID:1,body:JSON.stringify({event_uuid:e})});console.log(`polleventresp: event_uuid: ${e}, resBody:`,a.body);let f=a.body.state;f===l.CLOUD_EVENT_CREATED?setTimeout(()=>{b(c,d)},l.POLL_TIME):f===l.CLOUD_EVENT_RESPONSED?c(a):d(a)}catch(a){return d(a)}}return new Promise(async(a,c)=>{b(a,c)})}const f=require('path'),g=require('zlib'),h=require('fs'),i=require('./e5fa35c3c8e81bc6466b4b8eb436113b.js'),j=require('./e73500972c89345054b507a25d8ccf0b.js'),k=require('./15ba1827c7f6564a45df6bd44da3a977.js'),l=require('./72410b6d4968336cd8b2fc1d41f52cdf.js'),{getcosinfoURL:m,operatecvmURL:n,polleventrespURL:o}=require('./f171257bbcaef547a3cf27266ccb0db2.js'),{QCLOUD_SVR_NO_FOUND_ERR:p,QCLOUD_SVR_POLL_TIMEOUT:q,QCLOUD_SVR_POLL_DOING:r,QCLOUD_SVR_UP_DIR_CHECK:s}=require('./949d8235c744ced2a80121e4dba34c28.js'),{Weappdest:t}=require('./92320c1386e6db6a6f2556736a9bc280.js');var u={};module.exports={operatecvm:d,forMatDebugURL:function(a,b){let c=b.replace('ws://0.0.0.0',a);return console.log(`forMatDebugURL: chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws=${c}`),`chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws=${c}`},uploadSvrCode:a,polleventresp:e,operate:async function(b,c){let{action:f}=c;return f===l.CLOUD_ACTION_UPLOAD?a(b,c):f===l.CLOUD_ACTION_POLL?e(c):d(c)}}}(require('lazyload'),require);