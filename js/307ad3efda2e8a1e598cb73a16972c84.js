'use strict';var _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a};!function(require,directRequire){function a(a){console.error(a),console.trace()}const b=require('react'),c=require('fs'),d=require('glob'),e=require('path'),f=require('classnames'),g=require('./72653d4b93cdd7443296229431a7aa9a.js'),h=require('./15ba1827c7f6564a45df6bd44da3a977.js'),i=require('./da7c31daaf542cf1796023d8e344b98a.js'),j=require('./f171257bbcaef547a3cf27266ccb0db2.js'),k=require('./d3976cc01aeebc5b09e11c4135b6bd8d.js'),l=require('./56c390e04c10e91a4aa2a2c19d9a885d.js'),m=require('./common/locales/index.js'),n=require('./6620a0cf7dad1b400d60f0fdae40f524.js'),o=require('./d28a711224425b00101635efe1034c99.js'),p=require('./3c55dff3626a3ee184d599f076158345.js'),q=require('./9fdd4ac31a05c27355910f0d74accd4c.js'),{DEV_INVALID_APPID:r,DEV_APP_NOT_BAND:s}=require('./df6d0ff021a69fb541c733de4dbba0fe.js'),{default_weapp_header:t}=require('./5498e660c05c574f739a28bd5d202cfa.js'),u={network:{RequestDomain:[],WsRequestDomain:[],UploadDomain:[],DownloadDomain:[]},setting:{MaxLocalstorageSize:10,MaxCodeSize:5,MaxWebviewDepth:5,MaxBackgroundLifespan:300,MaxRequestConcurrent:5,MaxUploadConcurrent:1,MaxDownloadConcurrent:10,MaxFileStorageSize:100}};module.exports=class extends b.Component{constructor(a){super(a),this.state={projectpath:'',appid:'',appname:'',saveBtnDisable:!0,showQuickStart:!1,checked:!0,showLoading:!1,isTourist:!1,errorLoc:'',errorMsg:'.',compileType:{name:'\u5C0F\u7A0B\u5E8F\u6A21\u5F0F',value:q.weapp},showCompileTypeSelect:!1},this.compileTypeConstants=[{name:'\u5C0F\u7A0B\u5E8F\u6A21\u5F0F',value:q.weapp},{name:'\u4F1A\u8BDD\u52A8\u6001\u9875',value:q.conversation},{name:'\u641C\u7D22\u52A8\u6001\u9875',value:q.search}]}componentDidMount(){this.resize()}componentWillUnmount(){this.props.detach&&this.props.close()}resize(){try{let a=this.props.win?this.props.win:global.Win;this.props.detach||(a.show(),a.setResizable(!0),a.resizeTo(l.SIZE.CREATE_PROJECT.WIDTH,l.SIZE.CREATE_PROJECT.HEIGHT),a.setResizable(!1))}catch(a){}}editAppid(a){let b=a.target,c=b.value;const d={appid:c.trim()};'appid'===this.state.errorLoc&&(d.errorLoc=''),this.setState(d)}editAppname(a){let b=a.target,c=b.value;const d={appname:c};'projectname'===this.state.errorLoc&&(d.errorLoc=''),this.setState(d)}tourist(){let a=!this.state.isTourist,b={isTourist:a};a&&'appid'===this.state.errorLoc&&(b.errorLoc=''),this.setState(b)}chooseDir(){let a=this.props.win?this.props.win.window.document.body:global.contentDocumentBody,b=document.createElement('input');b.setAttribute('type','file'),b.setAttribute('nwdirectory',!0),b.style.display='none',a.appendChild(b),b.addEventListener('change',()=>{let d;try{d=c.readdirSync(b.value)}catch(a){return void this.setState({errorLoc:'projectpath',errorMsg:a.toString()})}let e=0===d.length;const f={projectpath:b.value,showQuickStart:e};'projectpath'===this.state.errorLoc&&(f.errorLoc=''),this.setState(f),a.removeChild(b)}),b.addEventListener('cancel',()=>{a.removeChild(b)}),b.click()}changeCheckbox(){this.setState({checked:!this.state.checked})}onTypeSelectClick(a){let b=this.compileTypeConstants[a],c={showCompileTypeSelect:!1};b&&(c.compileType=b),this.setState(c)}onCompileTypeClick(a){a.stopPropagation();let b=a.currentTarget.getBoundingClientRect();this.setState({compileTypeLeft:b.left,compileTypeTop:b.top+24,showCompileTypeSelect:!this.state.showCompileTypeSelect})}onContainerClick(){this.setState({showCompileTypeSelect:!1})}async addProject(){let b=this.state.projectpath,d=this.state.isTourist,e=d?'touristappid':this.state.appid,f=encodeURIComponent(this.state.appname.trim()),l=o.getVendorConfig(),n=l.currentLibVersion;if(!e)return void this.setState({errorLoc:'appid',errorMsg:m.config.CREATE_PROJECT_TIP_NO_APPID});if(!f)return void this.setState({errorLoc:'projectname',errorMsg:m.config.CREATE_PROJECT_TIP_NO_NAME});if(!b)return void this.setState({errorLoc:'projectpath',errorMsg:m.config.CREATE_PROJECT_TIP_NO_DIR});let p=`${e}_${f}`,q=k.strToHash(p),v=this.props.project.list[p];if(v)return void this.setState({appname:'',saveBtnDisable:!0,errorLoc:'projectname',errorMsg:m.config.CREATE_PROJECT_TIP_HASH_EXIST.formateLocales([e,decodeURIComponent(f)])});let w=this.state.showQuickStart&&this.state.checked;try{const a=c.readdirSync(b);if(0!==a.length&&0>a.indexOf('app.json')&&0>a.indexOf('project.config.json')&&0>a.indexOf('app-config.json'))return void this.setState({errorLoc:'projectpath',errorMsg:m.config.CREATE_PROJECT_TIP_MUST_USE_EMPTY_FOLDER})}catch(a){return void this.setState({errorLoc:'projectpath',errorMsg:a.toString()})}this.setState({showLoading:!0});let x={projectpath:'',appid:'',appname:'',error:'',saveBtnDisable:!0,showLoading:!1,isTourist:!1};if(d){let a={projectid:p,hash:q,appid:e,projectname:f,projectpath:b,appShowImageUrl:t,isAdmin:!1,isTourist:!0,urlCheck:!1,compileType:this.state.compileType.value,libVersion:n,attr:_extends({},u)};this.props.createProjectSuccess(a,w),this.setState(x),this.props.detach?(this.props.win.hide(),this.props.setConfirmInfo({show:!0,title:m.config.CONFIRM_OPEN_IN_THIS_WINDOW_TITLE,content:m.config.CONFIRM_OPEN_IN_THIS_WINDOW_CONTENT.formateLocales(f),callback:async(b)=>{if(b)try{this.props.setConfirmInfo({show:!1}),this.props.closeProject(),setTimeout(()=>{this.props.openProject(a.projectid),this.props.win.close()},50)}catch(a){this.props.win.close()}else this.props.win.close()}})):this.props.openProject(a.projectid),i(`project_createsuc`,e),h({url:`${j.touristCreateURL}?appid=${e}`,needToken:1}).then(()=>{}).catch((a)=>{g.error(`create tourist project error ${a}`)})}else try{const{resp:c,body:d}=await h({url:`${j.createWeappURL}?appid=${e}`,needToken:1,needCheckErrCode:1});this.setState({showLoading:!1}),g.info(`createstep.js create  ${d}`);let k=d,l=k.baseresponse,o=l?parseInt(l.errcode):0;if(o===s)return this.setState({errorLoc:'appid',errorMsg:'\u5F53\u524D\u5F00\u53D1\u8005\u672A\u7ED1\u5B9A\u6B64 AppID \uFF0C\u8BF7\u5230\u5C0F\u7A0B\u5E8F\u7BA1\u7406\u540E\u53F0\u64CD\u4F5C\u540E\u91CD\u8BD5'}),nw.Shell.openExternal('https://mp.weixin.qq.com/'),void g.error(`createstep.js create project error ${o}`);if(o===r)return this.setState({errorLoc:'appid',errorMsg:'\u4E0D\u5B58\u5728\u6B64 AppID \u8BF7\u68C0\u67E5\u540E\u91CD\u65B0\u8F93\u5165\u6216\u4F7F\u7528\u65E0 AppID \u6A21\u5F0F'}),void g.error(`createstep.js create project error ${o}`);if(0===o){let a=k.app_head_img?`${k.app_head_img}/0`:t,c=f;return k.app_nickname&&(c=encodeURIComponent(k.app_nickname)),v={isAdmin:k.is_admin,isTourist:!1,urlCheck:!0,projectid:p,hash:q,appid:e,projectname:f,projectpath:b,appShowImageUrl:a,libVersion:n,attr:{platform:!!k.is_platform,platformNickname:k.platform_nickname||'',appNickName:c}},v.appShowName=f,c!==f&&(v.appShowName=c),v.platform&&v.platformNickname&&(v.appShowName=v.platformNickname),this.props.createProjectSuccess(v,w),this.setState(x),this.props.detach?(this.props.win.hide(),this.props.setConfirmInfo({show:!0,title:m.config.CONFIRM_OPEN_IN_THIS_WINDOW_TITLE,content:m.config.CONFIRM_OPEN_IN_THIS_WINDOW_CONTENT.formateLocales(f),callback:async(a)=>{if(a)try{this.props.setConfirmInfo({show:!1}),this.props.closeProject(),setTimeout(()=>{this.props.openProject(v.projectid),this.props.win.close()},50)}catch(a){this.props.win.close()}else this.props.win.close()}})):this.props.openProject(v.projectid),void i(`project_createsuc`,e)}a(d||'\u7CFB\u7EDF\u9519\u8BEF')}catch(b){g.error(`create project error: ${b.toString()}`),this.setState({showLoading:!1}),a(b.toString())}}render(){let a=this.state.showQuickStart?{}:{display:'none'},c=this.props.cancel,d=this.state.isTourist,e=d?'\u65E0 AppID \u90E8\u5206\u529F\u80FD\u53D7\u9650':this.state.appid,g=d?'':'\u586B\u5199\u5C0F\u7A0B\u5E8FAppID ',h=d?'\u8FD4\u56DE\u586B\u5199\u5C0F\u7A0B\u5E8FAppID':'\u65E0 AppID ';const i='ui-form-item ui-form-item-inline',j=i+' ui-form-item-error',k={WebkitAppRegion:'no-drag'},l=this.compileTypeConstants.map((a)=>{return a.name});return b.createElement('div',{className:'dashboard',style:{WebkitAppRegion:'drag'},onClick:this.onContainerClick.bind(this)},b.createElement('div',{className:'dashboard-commands'},b.createElement('div',{className:'dashboard-navigator',style:this.props.detach?{display:'none'}:{}},b.createElement('a',{onClick:c,style:k},b.createElement('i',{className:'ui-icon-back'}))),b.createElement('div',{className:'dashboard-brand'},b.createElement('div',{className:'dashboard-logo'},b.createElement('i',{className:'ui-icon-mini-app'})),b.createElement('h3',{className:'dashboard-caption'},'\u5C0F\u7A0B\u5E8F\u9879\u76EE'),b.createElement('p',{className:'dashboard-subtitle'},'\u7F16\u8F91\u3001\u8C03\u8BD5\u5C0F\u7A0B\u5E8F')),b.createElement('div',{className:'dashboard-content'},b.createElement('div',{className:'ui-form'},b.createElement('div',{className:'appid'===this.state.errorLoc?j:i},b.createElement('label',{className:'ui-form-label'},'AppID'),b.createElement('div',{className:'ui-form-controls'},b.createElement('div',{className:'ui-input-box'},b.createElement('input',{style:k,className:'ui-input',value:e,onChange:this.editAppid.bind(this),type:'text',disabled:d,placeholder:''})),b.createElement('p',{className:'ui-form-tips',onClick:this.tourist.bind(this),style:k},d?'\u70B9\u6B64\u8FD4\u56DE\u586B\u5199 AppID':'\u8BF7\u586B\u5199\u5C0F\u7A0B\u5E8FAppID\uFF0C\u82E5\u65E0',d?null:b.createElement('a',null,'\u53EF\u70B9\u6B64\u4F53\u9A8C')))),b.createElement('div',{className:'ui-form-item ui-form-item-inline',style:{display:global.appConfig.isBeta?'':'none'}},b.createElement('label',{className:'ui-form-label'},'\u9879\u76EE\u7C7B\u578B'),b.createElement('div',{className:'ui-form-controls',onClick:this.onCompileTypeClick.bind(this)},b.createElement('div',{className:'ui-selector'},b.createElement('p',{className:'ui-selector-input'},this.state.compileType.name),b.createElement('div',{className:'ui-selector-dropdown'},b.createElement('i',{className:f({"ui-icon-arrow-down-o":!this.state.showCompileTypeSelect,"ui-icon-arrow-up-o":this.state.showCompileTypeSelect})})))),b.createElement(p,{list:l,left:this.state.compileTypeLeft,top:this.state.compileTypeTop,show:this.state.showCompileTypeSelect,onSelectClick:this.onTypeSelectClick.bind(this)})),b.createElement('div',{className:'projectname'===this.state.errorLoc?j:i},b.createElement('label',{className:'ui-form-label'},'\u9879\u76EE\u540D\u79F0'),b.createElement('div',{className:'ui-form-controls'},b.createElement('div',{className:'ui-input-box'},b.createElement('input',{type:'text',placeholder:'',className:'ui-input',style:k,value:this.state.appname,onChange:this.editAppname.bind(this)})))),b.createElement('div',{className:'projectpath'===this.state.errorLoc?j:i},b.createElement('label',{className:'ui-form-label'},'\u9879\u76EE\u76EE\u5F55'),b.createElement('div',{className:'ui-form-controls'},b.createElement('div',{className:'ui-flex',onClick:this.chooseDir.bind(this),style:k},b.createElement('div',{className:'ui-input-box'},b.createElement('input',{type:'text',disabled:!0,placeholder:this.state.projectpath,className:'ui-input'})),b.createElement('div',{className:'ui-selector ui-selector-default'},b.createElement('div',{className:'ui-selector-dropdown'},b.createElement('i',{className:'ui-icon-arrow-down-o'})))))),b.createElement('div',{className:'ui-form-item ui-form-item-inline',style:this.state.showQuickStart?{}:{display:'none'}},b.createElement('label',{htmlFor:'',className:'ui-form-label'}),b.createElement('div',{className:'ui-form-controls',onClick:this.changeCheckbox.bind(this),style:k},b.createElement('label',{htmlFor:'',className:'ui-checkbox'},b.createElement('input',{type:'checkbox'}),b.createElement('i',{className:this.state.checked?'ui-icon-checkbox-o':'ui-icon-checkbox'}),b.createElement('span',{className:'ui-checkbox-text'},'\u521B\u5EFA QuickStart \u9879\u76EE')))),b.createElement('div',{className:'ui-form-item ui-form-item-inline',style:this.state.errorLoc?{}:{display:'none'}},b.createElement('label',{className:'ui-form-label'}),b.createElement('div',{className:'ui-form-controls'},b.createElement('p',{className:'dashboard-error-tips'},this.state.errorMsg))))),b.createElement('div',{className:'dashboard-command-ft'},b.createElement('div',{className:'dashboard-command-action'},b.createElement('button',{className:'ui-button ui-button-primary',onClick:this.addProject.bind(this),style:k},'\u786E\u5B9A')))))}}}(require('lazyload'),require);