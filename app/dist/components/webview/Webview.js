"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},React=require("../../lib/react.js"),cssStr=require("../../cssStr/cssStr.js"),WebviewHeader=require("./WebviewHeader.js"),WebviewBody=require("./WebviewBody.js"),WebviewFooter=require("./WebviewFooter.js"),WebviewShare=require("./WebviewShare.js"),WebviewMark=require("./WebviewMask.js"),Webviewtabbar=require("./Webviewtabbar.js"),WebviewOperate=require("./WebviewOperate.js"),WebviewLoading=require("./WebviewLoading.js"),WebviewCard=require("./WebviewCards.js"),webviewStores=require("../../stroes/webviewStores.js"),webviewActions=require("../../actions/webviewActions.js"),windowActions=require("../../actions/windowActions.js"),log=require("../../common/log/log.js"),webviewNum=0,Webview=React.createClass({displayName:"Webview",getInitialState:function(){return{currentWebviewID:0,offset:webviewStores.getOffset(),showCard:!1,cardInfo:{},list:{0:{}}}},setAnimateImg:function(e,t){var i=document.createElement("div"),s=document.createElement("img");i.appendChild(s),s.src=t?t:"../images/webview.png",i.className="webview-animate-png";var r=this.refs["webviewBody"+this.state.currentWebviewID].refs.container,a=r.offsetTop,n=r.offsetLeft,o=r.offsetHeight,w=r.offsetWidth;global.contentDocumentBody.appendChild(i),e?i.style.cssText="width:"+w+"px;height:"+o+"px;top:"+a+"px;left:"+n+"px;transform:translate3d("+w+"px,0,0)":i.style.cssText="width:"+w+"px;height:"+o+"px;top:"+a+"px;left:"+n+"px;transform:translate3d(0,0,0)";i.offsetTop;return i},_geta8KeyNotSupport:function(e,t){windowActions.showTipsMsg("暂不支持当前URL的登录态拼接")},_webviewSDK:function(e,t,i,s){var r=this;log.info("Webview.js WEBVIEW_SDK "+e+", "+JSON.stringify(t)+", "+i+", "+JSON.stringify(s)),"openUrlWithExtraWebview"===i?!function(){var i=r.setAnimateImg(!0);i.style.transform="translate3d(0,0,0)",i.addEventListener("transitionend",function(){i.parentNode.removeChild(i),webviewNum++;var s=Object.assign({},r.state.list);s[webviewNum]={prevWebviewID:e,href:t.args.url},r.setState({currentWebviewID:webviewNum,list:s})})}():"dispatchEvent"===i&&!function(){var e=function s(){if(i.length){var e=parseInt(i.pop());webviewActions.setWebviewAction(e,{act:"sendMsg",sdkName:t.args.eventName,res:{data:t.args.data},ext:t.ext}),s()}},i=Object.keys(r.state.list);setTimeout(function(){e()})}()},_setWebviewOffset:function(e){this.setState({offset:e})},_changeWebviewID:function(e){log.info("Webview.js CHANGE_WEBVIEW_ID "+e),this.setState({currentWebviewID:e}),setTimeout(function(){webviewActions.setWebviewAction(e,{act:"sendMsg",sdkName:"onPageStateChange",res:{active:!0}})})},_cardSdk:function(e,t,i,s,r){this.setState({showCard:!0,cardInfo:{sdkName:t,data:r,webviewID:e,isHavePurview:s,cardData:i}}),windowActions.disAbleURLBar()},componentDidMount:function(){webviewStores.on("CRAD_SDK_RES",this._cardSdk),webviewStores.on("WEBVIEW_SDK",this._webviewSDK),webviewStores.on("SET_WEBVIEW_OFFSET",this._setWebviewOffset),webviewStores.on("CHANGE_WEBVIEW_ID",this._changeWebviewID),webviewStores.on("GETA_8KEY_NOT_SUPPORT",this._geta8KeyNotSupport)},componentWillUnmount:function(){webviewStores.removeListener("CRAD_SDK_RES",this._cardSdk),webviewStores.removeListener("GETA_8KEY_NOT_SUPPORT",this._geta8KeyNotSupport),webviewStores.removeListener("WEBVIEW_SDK",this._webviewSDK),webviewStores.removeListener("CHANGE_WEBVIEW_ID",this._changeWebviewID),webviewStores.removeListener("SET_WEBVIEW_OFFSET",this._setWebviewOffset)},goBack:function(e,t,i){var s=this;if(t.canGoBack()&&!i)t.back();else{var r=function(){if(0===e)return{v:void 0};var i=s.state.list[e],r=i.prevWebviewID,a=Object.assign({},s.state.list);setTimeout(function(){var i=webviewStores.getSnapShot(e),n=i?i.dataURI:"",o=s.setAnimateImg(!1,n),w=t.offsetWidth;s.refs["webview"+e].style.display="none",s.refs["webview"+r].style.display="flex",o.style.transform="translate3d("+w+"px,0,0)",o.addEventListener("transitionend",function(){o.parentNode.removeChild(o),webviewActions.deleteWebviewID(e),delete a[e],s.setState({list:a}),webviewActions.changeWebviewID(r)})})}();if("object"===("undefined"==typeof r?"undefined":_typeof(r)))return r.v}},enableFullScreen:function(e,t){var i=Object.assign({},this.state.list);i[e].enableFullScreen=t,this.setState({list:i})},showTabbar:function(e,t){var i=Object.assign({},this.state.list);i[e].showTabbar=!t,this.setState({list:i})},closeCard:function(){this.setState({showCard:!1,cardType:"",cardWebviewID:""}),windowActions.ableURLBar()},render:function(){var e=[],t=(this.state.currentWebviewID,this.state.offset);for(var i in this.state.list){var s=this.state.list[i],r={width:t.width};(this.state.currentWebviewID!=i||this.state.showCard)&&(r=Object.assign(r,cssStr.webviewDisplayNone));var a="body-webview";s.enableFullScreen&&(a+=" body-webview-fullscreen"),s.showTabbar&&(a+=" body-webview-showtabbar"),e.push(React.createElement("div",{ref:"webview"+i,style:r,className:a,key:i},React.createElement(WebviewHeader,{currentWebviewID:this.state.currentWebviewID,enableFullScreen:this.enableFullScreen,webviewID:i}),React.createElement(WebviewLoading,{webviewID:i}),React.createElement(WebviewBody,{offset:t,ref:"webviewBody"+i,goBack:this.goBack,webviewID:i,list:this.state.list}),React.createElement(WebviewMark,{offset:t,webviewID:i}),React.createElement(Webviewtabbar,{showTabbar:this.showTabbar,webviewID:i}),React.createElement(WebviewFooter,{webviewID:i}),React.createElement(WebviewShare,{offset:t,webviewID:i})))}return React.createElement("div",{className:"body-webview-container"},React.createElement(WebviewOperate,null),e,React.createElement(WebviewCard,{showCard:this.state.showCard,cardInfo:this.state.cardInfo,closeCard:this.closeCard}))}});module.exports=Webview;