"use strict";var React=require("../../lib/react.js"),cssStr=require("../../cssStr/cssStr.js"),webviewActions=require("../../actions/webviewActions.js"),webviewStores=require("../../stroes/webviewStores.js"),windowActions=require("../../actions/windowActions.js"),leftviewActions=require("../../actions/leftviewActions.js"),wechatCacheStores=require("../../stroes/wechatCacheStores.js"),tools=require("../../utils/tools.js"),log=require("../../common/log/log.js"),needGetA8key=!0,WebviewBody=React.createClass({displayName:"WebviewBody",getInitialState:function(){return{webviewID:parseInt(this.props.webviewID),src:"about:blank"}},_setWebviewActions:function(e,t){var s=this.webview,i=t.act,a=this.postMessage;switch(i){case"reLoad":s.reload();break;case"goBack":this.props.goBack(e,s);break;case"goForward":s.forward();break;case"load":needGetA8key="urlbar"!==t.from,s.src=t.url;break;case"goToBlank":s.src="app/html/about.html";break;case"sendMsg":a({command:"INVOKE_SDK",sdkName:t.sdkName,res:t.res,ext:t.ext});break;case"open":nw.Shell.openExternal(s.src);break;case"JSSDKLOG":a({command:"SHOW_CONSOLE_LOG",data:t});break;case"SNAPSHOT":a({command:"COMMAND_GET_SNAPSHOT"})}},_getJSSDKRes:function(e,t,s,i){log.info("WebviewBody.js GET_JSSDK_RES "+e+", "+t+", "+JSON.stringify(s)+", "+JSON.stringify(i)),this.postMessage({command:"GET_JSSDK_RES",sdkName:t,res:s,ext:i})},_setInterfaceRes:function(e,t,s){"closeWindow"===t&&(0===e?this.webview.src="app/html/about.html":this.props.goBack(e,this.webview,!0))},_clearWebviewData:function(e){var t=e.callBack;delete e.callBack,this.webview.clearData({since:0},e,function(){t&&t(),log.info("WebviewBody.js _clearWebviewData success ")})},_setWebviewUA:function(e){var t=e.replace("{{webviewID}}",this.state.webviewID);this.webview.setUserAgentOverride(t),log.info("WebviewBody.js _setWebviewUA success "+e),this.webview.reload()},componentDidMount:function(){var e=this,t=this.refs.container,s=this.webview=document.createElement("webview");s.className="body-webview-self",s.setAttribute("partition","persist:trusted");var i=0;t.appendChild(s);var a=this.postMessage=function(t){t.webviewID=e.state.webviewID,s.contentWindow.postMessage(t,"*")},n=webviewStores.getUA().replace("{{webviewID}}",this.state.webviewID);s.setUserAgentOverride(n);var o=["app/dist/inject/inject.js"];global.appConfig.haveAllPurview&&o.push("app/dist/inject/html2canvas.js"),s.addContentScripts([{name:"myRules",matches:["<all_urls>"],js:{files:o},run_at:"document_start"}]),window.addEventListener("message",function(t){var s=t.data,i=s.webviewID;if(i===e.state.webviewID){var a=s.command;switch(a){case"COMMAND_GET_TITLE":webviewActions.upWebviewStatus(i,{title:s.title});break;case"COMMAND_GET_SNAPSHOT":webviewActions.setWebviewSnapshot(i,s);break;case"COMMAND_FROM_WEBPAGE":webviewActions.execWebviewJSSDK(i,s)}"COMMAND_GET_SNAPSHOT"!==a&&log.info("WebviewBody.js message "+i+" "+JSON.stringify(s))}}),s.addEventListener("contentload",function(e){a({command:"handshake"}),a({command:"COMMAND_GET_TITLE"})}),s.addEventListener("loadstart",function(t){t.isTopLevel&&webviewActions.upWebviewStatus(e.state.webviewID,{loading:"start"})}),s.addEventListener("loadstop",function(t){webviewActions.upWebviewStatus(e.state.webviewID,{loading:"stop"})}),s.contextMenus.onShow.addListener(function(e){e.preventDefault()});var r=!1;s.addEventListener("loadcommit",function(t){if(t.isTopLevel){var i=s.canGoBack(),n=s.src;webviewActions.upWebviewStatus(e.state.webviewID,{canGoBack:i,url:n,type:"loadcommit"}),r||(webviewActions.openWebviewDevtools(e.state.webviewID,s),r=!0),windowActions.setAutoComplete(n),leftviewActions.hideAll(e.state.webviewID),a({command:"INVOKE_SDK",sdkName:"onPageStateChange",res:{active:!0}})}}),s.addEventListener("newwindow",function(e){log.info("WebviewBody.js newwindow "+JSON.stringify(e)),"new_window"===e.windowOpenDisposition&&(s.src=e.targetUrl)}),s.addEventListener("dialog",function(e){var t=e.messageType||"",s=e.messageText;if("alert"===t)alert(s);else if("confirm"===t){var i=confirm(s);i?e.dialog.ok():e.dialog.cancel()}else if("prompt"===t){var a=prompt(s);null!==a?e.dialog.ok(a):e.dialog.cancel()}});var w=s.request;w.onHeadersReceived.addListener(function(t){var s=t.responseHeaders,i=s.find(function(e){return"from-wechat-cache"===e.name});i&&wechatCacheStores.matchCacheFile(e.state.webviewID,t.url,i.value)},{urls:["<all_urls>"]},["responseHeaders"]),w.onBeforeRequest.addListener(function(t){if("main_frame"!==t.type)return{};if(i=0,webviewActions.webviewErr(e.state.webviewID,i),!needGetA8key)return needGetA8key=!0,{};var s=t.url;if(!/^chrome-extension:\/\//.test(s)&&!/^file:\/\//.test(s)){var a=/\#wechat_redirect$/.test(s);return webviewActions.getA8keyWebview(e.state.webviewID,{url:s,isSync:a}),{cancel:a}}},{urls:["<all_urls>"]},["blocking"]),s.addEventListener("consolemessage",function(t){var s=t.level;2===s&&(i++,webviewActions.webviewErr(e.state.webviewID,i))}),webviewStores.on("SET_WEBVIEW_ACTION_"+this.state.webviewID,this._setWebviewActions),webviewStores.on("GET_JSSDK_RES_"+this.state.webviewID,this._getJSSDKRes),webviewStores.on("SET_INTERFACE_RES_"+this.state.webviewID,this._setInterfaceRes),webviewStores.on("CLEAR_WEBVIEW_DATA",this._clearWebviewData),webviewStores.on("SET_WEBVIEW_UA",this._setWebviewUA);var c=this.props.list[this.state.webviewID].href;s.src=0===this.state.webviewID?webviewStores.getInitURL():c},componentWillUnmount:function(){var e=this.state.webviewID;webviewStores.removeListener("SET_WEBVIEW_ACTION_"+e,this._setWebviewActions),webviewStores.removeListener("GET_JSSDK_RES_"+e,this._getJSSDKRes),webviewStores.removeListener("SET_INTERFACE_RES_"+e,this._setInterfaceRes),webviewStores.removeListener("CLEAR_WEBVIEW_DATA",this._clearWebviewData),webviewStores.removeListener("SET_WEBVIEW_UA",this._setWebviewUA)},render:function(){var e={height:this.props.offset.height};return React.createElement("div",{ref:"container",style:e})}});module.exports=WebviewBody;