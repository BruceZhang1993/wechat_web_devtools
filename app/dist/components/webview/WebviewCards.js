"use strict";var React=require("../../lib/react.js"),cssStr=require("../../cssStr/cssStr.js"),webviewStores=require("../../stroes/webviewStores.js"),webviewActions=require("../../actions/webviewActions.js"),leftviewActions=require("../../actions/leftviewActions.js"),leftviewStores=require("../../stroes/leftviewStores.js"),log=require("../../common/log/log.js"),sdkNameTrans=require("../../common/jssdk/sdkNameTrans.js"),errcodeConfig=require("../../config/errcodeConfig.js"),batchAddCardURL="https://mp.weixin.qq.com/debug/cgi-bin/webdebugger/acceptcarditem",WebviewCard=React.createClass({displayName:"WebviewCard",getInitialState:function(){return{showDetails:!1}},cancel:function(){this.close();var e=this.props.cardInfo,a=e.data,t=e.webviewID,c=e.sdkName,r=e.isHavePurview;if("batchViewCard"!==c){var i={errMsg:sdkNameTrans.getSdkDisplayName(c)+":cancel"},d={type:"CARD_SDK"};webviewActions.sendJSSDKRes(t,c,i,a.ext),webviewActions.setSdkLog(t,a,r,i,d)}},close:function(e){return this.state.showDetails?void this.setState({showDetails:!1}):void this.props.closeCard()},batchAddCard:function(e){for(var a=this,t=e.currentTarget,c=t.dataset,r=c.index,i=this.props.cardInfo,d=i.data,s=d.args,o=i.webviewID,m=i.sdkName,n=i.isHavePurview,l=s.appId,w=this.props.cardInfo.cardData[r],v=s.card_list[r],b=[],_=0;_<w.amount;_++)b.push({card_id:v.card_id,card_ext:v.card_ext,is_succ:1});var N=require("../../common/request/request.js"),h={appid:l,acceptitem_list:b,js_checinfo_url:d.ext.url},R={url:batchAddCardURL,body:JSON.stringify(h),method:"post",needToken:!0},E={type:"CARD_SDK"};log.info("WebviewCards.js batchAddCard request begin "+JSON.stringify(R)),N(R,function(e,t,c){if(e){log.info("WebviewCards.js batchAddCard request error "+JSON.stringify(e));var r={errMsg:"addCard:fail; "+JSON.stringify(e)};webviewActions.sendJSSDKRes(o,m,r,d.ext),webviewActions.setSdkLog(o,d,n,r,E),a.close()}else{log.info("WebviewCards.js batchAddCard request end "+c);var i=JSON.parse(c),s=i.baseresponse;if(0===s.errcode){var r={errMsg:"addCard:ok",card_list:JSON.stringify(b)},l=b.map(function(e){return{cardExt:e.card_ext,cardId:e.card_id,isSuccess:!0}}),w={errMsg:"addCard:ok",cardList:l};webviewActions.sendJSSDKRes(o,m,r,d.ext),webviewActions.setSdkLog(o,d,n,w,E),a.close()}else{var r={errMsg:"addCard:fail; "+s.errmsg};webviewActions.sendJSSDKRes(o,m,r,d.ext),webviewActions.setSdkLog(o,d,n,r,E),a.close()}}})},chooseCard:function(e){var a=this.props.cardInfo,t=a.data,c=a.sdkName,r=a.webviewID,i=a.isHavePurview,d=e.currentTarget,s=d.dataset,o={type:"CARD_SDK"},m=[{card_id:s.cardid,encrypt_code:s.encryptcode}],n={errMsg:"chooseCard:ok",choose_card_info:JSON.stringify(m)};webviewActions.sendJSSDKRes(r,c,n,t.ext),webviewActions.setSdkLog(r,t,i,n,o),this.close()},formatTime:function(e){var a=new Date(1e3*e);return a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate()},cardDetail:function(e){var a=e.currentTarget,t=a.dataset,c=t.index;this.setState({showDetails:!0,cardIndex:c})},render:function(){var e=this,a=this.props.showCard?{}:cssStr.displayNone,t=webviewStores.getOffset();delete t.dpr,a=Object.assign({},a,t);var c=this.props.cardInfo,r=c.sdkName,i=c.cardData,d=React.createElement("div",null);if("batchAddCard"===r)!function(){var a={},t=i.map(function(t,c){if(t.errmsg)return React.createElement("div",{className:"webview-card-add-item",key:c},React.createElement("div",{className:"webview-card-add-item_top"},React.createElement("div",{className:"webview-card-add-item_details"},React.createElement("div",{className:"webview-card-add-item_name"},"cardId: ",t.card_id),React.createElement("div",{className:"webview-card-add-item_info"},React.createElement("span",{className:"webview-card-add-item_intro"},"errmsg: ",t.errmsg)))),React.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_error"},React.createElement("div",{className:"webview-card-add-item_button"},"错误卡券")));var r=t.card_tp_info,i=r.brand_name,d=r.title,s=r.logo_url,o=t.card_data_info;a.backgroundColor=r.color;var m=e.formatTime(r.begin_time),n=e.formatTime(r.end_time),l=0===o.limit_num,w=void 0;return w=l?React.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable",style:a},React.createElement("div",{className:"webview-card-add-item_button_error"},r.limit_wording)):React.createElement("div",{"data-index":c,onClick:e.batchAddCard,className:"webview-card-add-item_bottom",style:a},React.createElement("div",{className:"webview-card-add-item_button"},r.accept_wording)),React.createElement("div",{className:"webview-card-add-item",key:c},React.createElement("div",{className:"webview-card-add-item_top"},React.createElement("div",{className:"webview-card-add-item_left"},React.createElement("img",{className:"webview-card-add-item_img",src:s})),React.createElement("div",{className:"webview-card-add-item_details"},React.createElement("div",{className:"webview-card-add-item_name"},i),React.createElement("div",{className:"webview-card-add-item_info"},React.createElement("span",{className:"webview-card-add-item_intro"},d),React.createElement("span",{className:"webview-card-add-item_num"},"X",t.amount)),React.createElement("div",{className:"webview-card-add-item_time"},m," - ",n))),w)});d=React.createElement("div",{className:"webview-card-add",style:a},React.createElement("div",{className:"webview-card-add-header"},React.createElement("div",{className:"webview-card-add-header_button",onClick:e.cancel}," 取消 "),React.createElement("div",{className:"webview-card-add-header_title"}," 添加卡卷 ")),React.createElement("div",{className:"webview-card-add-container"},t))}();else if("chooseCard"===r){var s=i.available_cards,o=s.map(function(a,t){return React.createElement("div",{onClick:e.chooseCard,key:t,"data-appid":a.app_id,"data-cardid":a.card_tp_id,"data-encryptcode":a.encrypt_code,className:"webview-card-choose-item"},React.createElement("div",{className:"webview-card-choose_m"},React.createElement("div",{className:"webview-card-choose_left"},React.createElement("img",{className:"webview-card-choose-item_img",src:a.logo_url})),React.createElement("div",{className:"webview-card-choose_details"},React.createElement("div",{className:"webview-card-choose-item_name"},a.sub_title),React.createElement("div",{className:"webview-card-choose-item_info"},a.title))))}),m=void 0;m=o.length?React.createElement("div",{className:"webview-card-choose-container"},React.createElement("span",{className:"webview-card-choose-mycard"},"我的卡卷"),React.createElement("div",{className:"webview-card-choose-item"},o)):React.createElement("div",{className:"webview-card-choose-container"},React.createElement("span",{className:"webview-card-choose-mycard webview-card-choose-mycardEmpty"},"暂无可添加的卡券")),d=React.createElement("div",{className:"webview-card-choose"},React.createElement("div",{className:"webview-card-choose-header"},React.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 取消 "),React.createElement("div",{className:"webview-card-choose-header_title"}," 选择卡卷 ")),m)}else if("batchViewCard"===r){var n=c.cardData.retData.card_array,l=c.cardData.errData,w=!!l.length,v=this.state.showDetails;if(1===n.length&&!w||v){var b=v?n[this.state.cardIndex]:n[0],_=b.card_data_info,N=this.formatTime(_.begin_time),h=this.formatTime(_.end_time),R=b.card_tp_info,E=R.brand_name,u=R.title,p=R.logo_url,g=0===R.limit_num,f=void 0,C={};C.backgroundColor=R.color,f=g?React.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable"},React.createElement("div",{className:"webview-card-add-item_button_error"},R.limit_wording)):React.createElement("div",{onClick:this.batchAddCard,className:"webview-card-add-item_bottom"},React.createElement("div",{className:"webview-card-add-item_button"},R.accept_wording));var S=v?"返回":"关闭";d=React.createElement("div",{className:"webview-card-open",style:C},React.createElement("div",{className:"webview-card-open-header"},React.createElement("div",{className:"webview-card-open-header_button",onClick:this.cancel}," ",S," ")),React.createElement("div",{className:"webview-card-open-container"},React.createElement("div",{className:"webview-card-open_top"},React.createElement("img",{className:"webview-card-open-item_img",src:p})),React.createElement("div",{className:"webview-card-open_middle"},React.createElement("div",{className:"webview-card-open-name"},E),React.createElement("div",{className:"webview-card-open-intro"},u),React.createElement("div",{className:"webview-card-open-item_button",style:C},React.createElement("div",{className:"webview-card-open_buttom_wording"},"立即使用")),React.createElement("div",{className:"webview-card-open-time"},"有效期: ",N,"-",h)),React.createElement("div",{className:"webview-card-open_bottom"},React.createElement("div",{className:"webview-card-open_detail"},"兑换卷详情"),React.createElement("div",{className:"webview-card-open_detail"},"公众号"),React.createElement("div",{className:"webview-card-open_detail"},"在线兑换"))))}else{var o=n.map(function(a,t){var c=a.card_tp_info;return React.createElement("div",{onClick:e.cardDetail,key:t,"data-index":t,className:"webview-card-choose-item"},React.createElement("div",{className:"webview-card-choose_m"},React.createElement("div",{className:"webview-card-choose_left"},React.createElement("img",{className:"webview-card-choose-item_img",src:c.logo_url})),React.createElement("div",{className:"webview-card-choose_details"},React.createElement("div",{className:"webview-card-choose-item_name"},c.brand_name),React.createElement("div",{className:"webview-card-choose-item_info"},c.title))))}),k=l.map(function(e,a){var t="INVALID_CODE"===errcodeConfig[e.errcode]?"错误卡券 ID":"错误卡卷 code";return React.createElement("div",{key:a,className:"webview-card-choose-item"},React.createElement("div",{className:"webview-card-choose_mErr"},React.createElement("div",{className:"webview-card-choose_details"},React.createElement("div",{className:"webview-card-choose-item_error"},t),React.createElement("div",{className:"webview-card-choose-item_error"},"cardId: ",e.card_id),React.createElement("div",{className:"webview-card-choose-item_error"},"code: ",e.code))))});d=React.createElement("div",{className:"webview-card-choose"},React.createElement("div",{className:"webview-card-choose-header"},React.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 关闭 "),React.createElement("div",{className:"webview-card-choose-header_title"}," 卡券列表 ")),React.createElement("div",{className:"webview-card-choose-container"},React.createElement("div",{className:"webview-card-choose-item"},o,k)))}}return React.createElement("div",{className:"webview-card",style:a},d)}});module.exports=WebviewCard;