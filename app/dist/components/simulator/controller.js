"use strict";function init(){var e=(require("fs"),require("../../lib/react.js")),t=require("../../lib/react-dom.js"),i=require("./toolbar/toolbar.js"),r=require("./webviewtab.js"),s=require("./share/webviewWeappShare.js"),a=require("querystring"),o=require("./webview.js"),n=require("../../weapp/utils/tools.js"),c=require("../../stores/webviewStores.js"),h=require("../../stores/windowStores.js"),l=require("../../actions/windowActions.js"),u=(require("../../actions/webviewActions.js"),require("../../stores/projectStores.js"),require("../../cssStr/cssStr.js")),p=require("../../common/log/log.js"),w=(require("../../common/request/request.js"),require("./actions/simulatorActions.js")),v=require("./webviewBackwardMask.js"),b=require("./payment/webviewpayment.js"),d=(require("../../utils/tools.js"),require("url")),f=(require("../../config/urlConfig.js"),require("../../weapp/utils/projectManager.js")),g=require("./webview/modal.js"),m=require("./webview/toast.js"),S=require("./webview/picker.js"),W=require("./webview/actionSheet.js"),I=require("./webview/authorizeDialog.js"),E=require("./webview/settingDialog.js"),_=require("./webview/confirm.js"),N=require("./webview/previewImage.js"),D=require("./webview/addCardView.js"),j=require("./webview/openCardView.js"),y=require("./grouplist/grouplist.js"),R=require("../../config/weappConfig.js"),T=R.default_scene,A=require("../../config/weappConfig.js"),O=A.default_android_tabbar_height,q=A.default_ios_tabbar_height,B=A.default_backgroundColor,C=A.default_android_titlebar_height,k=A.default_ios_titlebar_height,P=require("./sdkimplement/index.js"),U=0,L=e.createClass({displayName:"Controller",getInitialState:function(){var e="app/html/about.html",t=0,i=0,r=0,s={},a={window:{}},o={},n={},c=h.getOffset(),u=!1,p=!1,w="",v="",b="",d="",g=this.props.project;if(g){try{if(e=f.getAppEntranceSync(g),a=f.getAppJSONSync(g),s=a.tabBar||{},g.initPath&&g.initPath.enable&&g.initPath.page)n=f.getPageJSONSync(g,g.initPath.page);else{var m=a.pages||[];n=f.getPageJSONSync(g,m[0])}var S=this.getTabPageIndex(e,s);u=S>-1&&this.getRouteName(s.list[S].pagePath)}catch(t){e=""}setTimeout(function(){l.changeUrl(e,t)})}var W=!1;return{currentWebviewID:t,topWebviewID:i,webviewReady:!1,showCard:p,tabBar:s,appJSON:a,offset:c,cardInfo:o,showRecordWording:W,list:{0:{href:e,dataURI:w,preWebviewID:r,pageJSON:n,isTabbar:u,shareBtnState:{show:!1,isDynamic:!1,withShareTicket:!1},shareDataURI:void 0}},shareInfo:{show:!1,imgUrl:"",title:"",desc:""},uuid:v,qrcode:b,qrcodeState:d,scene:g&&g.initPath&&g.initPath.enable&&g.initPath.scene||T}},createWebviewId:function(){return++U},setAnimateImg:function(e,i){var r=document.createElement("div");if(i.dataURI){var s=document.createElement("img");r.appendChild(s),s.src=i.dataURI}r.className="simulator-animate-png";var a=t.findDOMNode(this.refs["webview"+this.state.currentWebviewID]),o=a.getBoundingClientRect(),n=o.top,c=o.left,h=o.height,l=o.width;e?r.style.cssText="background-color:"+i.color+";width:"+l+"px;height:"+h+"px;top:"+n+"px;left:"+c+"px;transform:translate3d("+l+"px,0,0)":r.style.cssText="margin-top:42px;width:"+l+"px;height:"+(h-42)+"px;top:"+n+"px;left:"+c+"px;transform:translate3d(0,0,0)",global.contentDocumentBody.appendChild(r);r.offsetTop;return r},getRouteName:function(e){return e?d.parse(e).pathname.split(".")[0].replace(/^\//,""):""},postAppRoute:function(e,t,i,r){if(this.props.project){var s=d.parse(e),a=s.pathname.replace(/^\//,""),o=(s.query||"").split("&"),n={};o.forEach(function(e){var t=e.split("=");t[0]&&(n[t[0]]=t[1])}),this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:r?"onAppRouteDone":"onAppRoute",type:"ON_APPLIFECYCLE_EVENT",data:{path:a||"index.html",query:n,openType:i},webviewID:parseInt(t)})}},goBack:function(e,i,r,s){var a=this;if(s=s||1,this.props.project||!i.canGoBack()||r){if(this.props.project){if(e===this.state.topWebviewID||1==Object.keys(this.state.list).length)return;var o=this.state.list[e];if(!o||o.isTabbar)return;for(var n,c=e,h=[];s--&&this.state.list[c]&&0!=c;)h.push(c),n=this.state.list[c],c=n.prevWebviewID;this.state.list[c]||(c=0);var l=t.findDOMNode(this.refs["webview"+e]),u=l.querySelector(".webviewbody"+e),p=t.findDOMNode(this.refs["webview"+c]),w=p.querySelector(".webviewbody"+c);o.isMap||this.postAppRoute(w.src,c,"navigateBack"),u.captureVisibleRegion(function(e){var t=a.setAnimateImg(!1,{dataURI:e}),i=u.offsetWidth,r=Object.assign({},a.state.list);for(var s in h)delete r[h[s]];a.setState({list:r,currentWebviewID:c}),t.addEventListener("transitionend",function(){global.contentDocumentBody.removeChild(t),a.postAppRoute(w.src,c,"navigateBack",!0);for(var e in h)a.getSimulatorActions("S_DELETE_WEBVIEW",null,{webviewID:h[e]});a.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:c})}),t.style.transform="translate3d("+i+"px,0,0)"})}}else i.back()},_getOpenWebviewNum:function(){var e=this.state.list,t=0,i=!1;for(var r in e)!i&&e[r].isTabbar&&(i=!0,t++),e[r].isTabbar||t++;return t},_openNewWebview:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=e.url,r=e.isMap,s=e.type,a=this.state.currentWebviewID;if(!e.isMap&&this._getOpenWebviewNum()>=5)return void t("webview count limit exceed");var o=this.state.appJSON,n={},c=B;if(!r){try{n=f.getPageJSONSync(this.props.project,i)}catch(e){}c=n.backgroundColor||o.window.backgroundColor||B}var h=this.setAnimateImg(!0,{color:c});U++;var l=Object.assign({},this.state.list);l[U]={prevWebviewID:a,href:i,pageJSON:n,isMap:r,type:s},this.setState({currentWebviewID:U,list:l}),this.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:U}),h.addEventListener("transitionend",function(){global.contentDocumentBody.removeChild(h),t(null,U)}),h.style.transform="translate3d(0,0,0)"},_openNewWindowWebview:function(e){var t=this,i=e.url,r=this.getRouteName(i),s={},a=this.props.project;try{s=f.getPageJSONSync(a,i)}catch(e){}var o=(s.backgroundColor||"#ffffff",n.getBaseURL(a));i=d.resolve(o,i+".html");var c=Object.assign({},this.state.list),h={},l={};for(var u in c){var p=c[u];p.isTabbar&&(p.isTabbar===r&&(l.currentWebviewID=parseInt(u)),h[u]=p)}l.list=h;var w=!1;void 0===l.currentWebviewID&&(l.currentWebviewID=++U,l.list[U]={showUrl:!1,hideBack:!0,isTabbar:r,href:i,pageJSON:s,type:"switchTab"},w=!0);var v=l.currentWebviewID,b=l.currentWebviewID!=this.state.currentWebviewID;return this.setState(l,function(){setTimeout(function(){!w&&b&&(t.postAppRoute(i,v,"switchTab"),t.postAppRoute(i,v,"switchTab",!0)),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:v})},0)}),v},_changeWebviewID:function(e){this.setState({currentWebviewID:e})},_setWebviewInfo:function(e){var t=this.state.tabBar;t.list||[];e.height&&this.setState({offset:{height:e.height-(this.props.project?0:42),width:e.width,dpr:e.dpr}})},_setWebviewSnapshot:function(e,t){var i=Object.assign({},this.state.list);i[e].dataURI=t,this.setState({list:i})},_postMessageToAllWebview:function(e){var t=this,i=e.webviewIds||[],r=0===i.length;setTimeout(function(){e.act="sendMsgFromAppService";var s=void 0;s=r?Object.keys(t.state.list):i,s.forEach(function(i){t.getSimulatorActions("S_SET_ACTION",i,e)})},17)},doSimulaterActions:function(e,i,r){var s=function(){"function"==typeof r&&r.apply(r,arguments)};switch(e){case"OPEN_NEW_WEBVIEW":this._openNewWebview(i,s);break;case"OPEN_NEW_WINDOW_WEBVIEW":this._openNewWindowWebview(i),s(null);break;case"WEBVIEW_BACK":var a=this.state.currentWebviewID,o=t.findDOMNode(this.refs["webview"+a]),n=o.querySelector(".webviewbody"+a);this.goBack(this.state.currentWebviewID,n,!1,i.delta);break;case"CAPTRUE_WEBVIEW":var c=this.state.currentWebviewID,h=t.findDOMNode(this.refs["webview"+c]),l=h.querySelector(".webviewbody"+c);l.captureVisibleRegion(function(e){s(null,e)})}},getWebviewList:function(){return Object.assign({},this.state.list)},onShareGroupSelect:function(e){var t=this.state.shareInfo;t.group=e,this.setState({shareInfo:t});var i=this.state.list[this.state.currentWebviewID],r=i.shareBtnState;this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onShareAppMessage",data:{dynamic:!!r.isDynamic,mode:r.withShareTicket?"withShareTicket":"common"},webviewID:this.state.currentWebviewID})},_upWebviewStatus:function(e,t){var i=this;0===e&&"start"===t.loading&&setTimeout(function(){i.state.webviewReady||i.setState({webviewReady:!0})},5e3),0===e&&"about:blank"!==t.url&&"stop"===t.loading&&this.setState({webviewReady:!0}),this.upCurrentWebviewURL(t.url)},_toggleRecordWording:function(e){this.setState({showRecordWording:e})},_onSumilatorNetworkChange:function(e){this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onNetworkStatusChange",data:{networkType:e,isConnected:"none"!=e},webviewID:parseInt(this.state.currentWebviewID)})},_onWebviewInterface:function(e,i,r,s){var a=this;"initReady"===i&&setTimeout(function(){try{o()}catch(e){p.error("controller.js: _onWebviewInterface first onReady attempt fail, to retry, error: "+e.toString()),setTimeout(function(){try{o()}catch(e){p.error("controller.js: _onWebviewInterface second onReady attempt fail, error: "+e.toString())}},200)}},200);var o=function(){var i=t.findDOMNode(a.refs["webview"+e]),r=i.querySelector(".webviewbody"+e);r.captureVisibleRegion(function(t){var i=Object.assign({},a.state.list);i[e]&&(i[e].shareDataURI=t,a.setState({list:i}))})}},getTabPageIndex:function(e,t){var i=n.getFileNameFromUrl(e,this.props.project).replace(/\.wxml$/,"");t=t||this.state.tabBar;var r=t.list||[],s=r.findIndex(function(e){return e.pagePath===i});return s},upCurrentWebviewURL:function(e){},getSimulatorActions:function(e,i,r){var s=this,a=function(){var e=r.webviewID;if(e===s.state.currentWebviewID){var i=t.findDOMNode(s.refs["webview"+e]),a=i.querySelector("webview"),o=a.src;s.upCurrentWebviewURL(o),l.changeUrl(o,e)}},o={currentWebviewID:this.state.currentWebviewID};if(w(e,i,r,o),"S_CHANGE_CURRENT_WEBVIEW"===e)try{a()}catch(e){p.info("controller.js: getSimulatorActions first attempt failed, will retry, errorMessage: "+e.toString()),setTimeout(function(){try{a()}catch(e){p.error("controller.js: getSimulatorActions second attempt failed, error: "+e.toString())}},2e3)}},projectHasTab:function(){var e=this.state.tabBar.list||[],t=e.length;return t&&e.length<=5&&e.length>=2},_onAppEnterForground:function(e){this.setState({scene:e.scene})},componentDidMount:function(){c.on("CHANGE_WEBVIEW_ID",this._changeWebviewID),h.on("SET_WEBVIEW_INFO",this._setWebviewInfo),c.on("AS_PUBLISH",this._postMessageToAllWebview),c.on("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.on("UP_WEBVIEW_STATUS",this._upWebviewStatus),c.on("TOGGLE_RECORD_WORDING",this._toggleRecordWording),c.on("SET_INTERFACE_ASYNC_RES",this._onWebviewInterface),c.on("SIMULATOR_NETWORK_CHANGE",this._onSumilatorNetworkChange),h.on("APP_ENTER_FOREGROUND",this._onAppEnterForground);var e=this.props.project?1:12;chrome.fontSettings.setMinimumFontSize({pixelSize:e}),P.register(this)},componentWillUnmount:function(){c.removeListener("CHANGE_WEBVIEW_ID",this._changeWebviewID),h.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),c.removeListener("AS_PUBLISH",this._postMessageToAllWebview),c.removeListener("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),c.removeListener("UP_WEBVIEW_STATUS",this._upWebviewStatus),c.removeListener("TOGGLE_RECORD_WORDING",this._toggleRecordWording),c.removeListener("SET_INTERFACE_ASYNC_RES",this._onWebviewInterface),c.removeListener("SIMULATOR_NETWORK_CHANGE",this._onSumilatorNetworkChange),h.removeListener("APP_ENTER_FOREGROUND",this._onAppEnterForground),P.unregister(this)},chooseLocation:function(){},closeLocation:function(){},hideShare:function(){var e={show:!1};this.setState({shareInfo:e})},render:function(){var t=[];for(var n in this.state.list){var l=n==this.state.currentWebviewID?{}:u.webviewDisplayNone,p=this.state.list[n],w=this.getTabPageIndex(p.href),f=null,R=null,A=Object.assign({},this.state.offset),B=h.getWebviewInfo();if(this.props.project){if(this.projectHasTab()&&w>-1){var P=this.state.tabBar.position,U={width:this.state.offset.width,margin:"0 auto"},L=e.createElement("div",{style:U},e.createElement(r,{webviewID:n,tabPageIndex:w,project:this.props.project,_openNewWindowWebview:this._openNewWindowWebview,tabBar:this.state.tabBar,webviewReady:this.state.webviewReady}));"top"===P?f=L:R=L;var M=void 0;M="iOS"===B.os?q:O,A.height=A.height-M}"iOS"===B.os?A.height=A.height-k-20:A.height=A.height-C-c.getStatusBarHeight()}else A.height-=42;t.push(e.createElement("div",{key:n,style:l},e.createElement("div",{className:"simulator-shadow",style:{width:A.width}},e.createElement(o,{showRecordWording:this.state.showRecordWording,type:p.type,ref:"webview"+n,webviewID:n,project:this.props.project,offset:A,isTabWebview:w>-1,href:p.href,pageJSON:p.pageJSON,appJSON:this.state.appJSON,isMap:p.isMap,chooseLocation:this.chooseLocation,closeLocation:this.closeLocation,hideBack:!!p.hideBack,goBack:this.goBack,getSimulatorActions:this.getSimulatorActions,postAppRoute:this.postAppRoute,topTabDom:f,shareBtnState:p.shareBtnState}),R)))}var x=this.props.project?e.createElement(s,{shareInfo:this.state.shareInfo,hideShare:this.hideShare}):null,V=!!this.props.project,G=u.displayNone,H=void 0,F=void 0,J=u.displayNone,z=void 0;if(V){var K=this.state.list[this.state.currentWebviewID];if(K&&K.href){var Y=d.parse(K.href);if(G={},H=Y.pathname.replace(".html","").replace(/^\//,""),this.state.currentWebviewID==this.state.topWebviewID)F=Y.query;else{var $=a.parse(Y.query||""),Q=[];for(var X in $)Q.push(X+"="+$[X]);F=Q.join("&")}}F&&(J={}),z=this.state.scene||T}return e.createElement("div",{className:"simulator-wrapper"},e.createElement(i,{getSimulatorActions:this.getSimulatorActions,list:this.state.list,currentWebviewID:this.state.currentWebviewID,project:this.props.project,show:this.props.show}),e.createElement("div",{className:"simulator-list-wrapper",style:{width:this.state.offset.width}},x,t,e.createElement(D,{project:this.props.project}),e.createElement(j,{project:this.props.project}),e.createElement(W,{webviewID:this.state.currentWebviewID}),e.createElement(m,{project:this.props.project,webviewID:this.state.currentWebviewID}),e.createElement(g,{webviewID:this.state.currentWebviewID}),e.createElement(_,{webviewID:this.state.currentWebviewID}),e.createElement(S,{webviewID:this.state.currentWebviewID}),e.createElement(N,{width:this.state.offset.width,project:this.props.project}),e.createElement(b,null),e.createElement(I,null),e.createElement(E,{project:this.props.project}),e.createElement(y,{shareBtnState:this.state.list[this.state.currentWebviewID].shareBtnState,onSelect:this.onShareGroupSelect})),e.createElement(v,null),e.createElement("div",{className:"simulator-status-bar",style:G},e.createElement("p",{className:"simulator-status-bar-item"},e.createElement("label",null,"场景值："),e.createElement("span",{title:z},z)),e.createElement("p",{className:"simulator-status-bar-item"},e.createElement("label",null,"页面路径："),e.createElement("span",{title:H},H)),e.createElement("p",{style:J,className:"simulator-status-bar-item"},e.createElement("label",null,"页面参数："),e.createElement("span",{title:F},F))))}});_exports=L}var _exports;init(),module.exports=_exports;