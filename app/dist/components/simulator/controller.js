'use strict';var _exports;function init(){function a(I){m.showTipsMsg({msg:I,type:'error'})}require('fs');const b=require('../../lib/react.js'),c=require('../../lib/react-dom.js'),d=require('./toolbar/toolbar.js'),f=require('./webviewtab.js'),g=require('./webviewWeappShare.js'),h=require('querystring'),j=require('./webview.js'),k=require('../../weapp/utils/tools.js'),l=require('../../stores/webviewStores.js');require('../../stores/windowStores.js');const m=require('../../actions/windowActions.js');require('../../actions/webviewActions.js'),require('../../stores/projectStores.js');const n=require('../../cssStr/cssStr.js'),o=require('../../common/log/log.js'),p=require('../../common/request/request.js'),q=require('./actions/simulatorActions.js'),r=require('./webviewBackwardMask.js'),s=require('./payment/webviewpayment.js');require('../../utils/tools.js');const t=require('url'),u=require('../../config/urlConfig.js'),v=require('../../weapp/utils/projectManager.js'),w=require('./webview/modal.js'),x=require('./webview/toast.js'),y=require('./webview/picker'),z=require('./webview/actionSheet.js'),A=require('./webview/confirm.js'),B=require('./webview/previewImage.js'),{default_tabheight:C,default_backgroundColor:D}=require('../../config/weappConfig.js');var E=0,F=0,G;const H=b.createClass({displayName:'Controller',getInitialState:function(){let I='app/html/about.html',J={},K={window:{}},L={},M=l.getOffset(),N=!1,O=this.props.project;if(O){try{I=v.getAppEntranceSync(O),K=v.getAppJSONSync(O),J=K.tabBar||{};let Q=K.pages||[];L=v.getPageJSONSync(O,Q[0])}catch(Q){I=''}let P=this.getTabPageIndex(I,J);N=!!(-1<P)&&this.getRouteName(J.list[P].pagePath)}return{currentWebviewID:0,topWebviewID:0,showCard:!1,tabBar:J,appJSON:K,offset:M,cardInfo:{},showRecordWording:!1,list:{0:{href:I,dataURI:'',preWebviewID:0,pageJSON:L,isTabbar:N}},share:{show:!1,imgUrl:'',title:'',desc:''},uuid:'',qrcode:'',qrcodeState:'',shareBtnShow:{}}},setAnimateImg:function(I,J){let K=document.createElement('div');if(J.dataURI){let R=document.createElement('img');K.appendChild(R),R.src=J.dataURI}K.className='simulator-animate-png';let L=c.findDOMNode(this.refs[`webview${this.state.currentWebviewID}`]),M=L.getBoundingClientRect(),N=M.top,O=M.left,P=M.height,Q=M.width;return K.style.cssText=I?`background-color:${J.color};width:${Q}px;height:${P}px;top:${N}px;left:${O}px;transform:translate3d(${Q}px,0,0)`:`margin-top:42px;width:${Q}px;height:${P-42}px;top:${N}px;left:${O}px;transform:translate3d(0,0,0)`,global.contentDocumentBody.appendChild(K),K.offsetTop,K},getRouteName:function(I){return t.parse(I).pathname.split('.')[0].replace(/^\//,'')},postAppRoute:function(I,J,K){if(this.props.project){var L=t.parse(I),M=L.pathname.replace(/^\//,'');this.getSimulatorActions('S_POSTMSG_TO_AS',null,{eventName:'onAppRoute',type:'ON_APPLIFECYCLE_EVENT',data:{path:M||'index.html',query:h.parse(L.query||''),openType:K},webviewID:J})}},goBack:function(I,J,K,L){if(L=L||1,!this.props.project&&J.canGoBack()&&!K)J.back();else{if(I===this.state.topWebviewID||1==Object.keys(this.state.list).length)return;for(var M,N=I,O=[];L--&&this.state.list[N]&&0!=N;)O.push(N),M=this.state.list[N],N=M.prevWebviewID;this.state.list[N]||(N=0);let P=c.findDOMNode(this.refs[`webview${I}`]),Q=P.querySelector(`.webviewbody${I}`);Q.captureVisibleRegion(R=>{let S=this.setAnimateImg(!1,{dataURI:R}),T=Q.offsetWidth,U=Object.assign({},this.state.list);for(var V in O)delete U[O[V]];this.setState({list:U,currentWebviewID:N},()=>{S.addEventListener('transitionend',()=>{global.contentDocumentBody.removeChild(S);let W=c.findDOMNode(this.refs[`webview${N}`]),X=W.querySelector(`.webviewbody${N}`);if(this.props.project){let Z=J.src,$=k.getBaseURL(this.props.project);0===Z.indexOf($)&&this.postAppRoute(X.src,this.state.currentWebviewID,'navigateBack')}for(var Y in O)this.getSimulatorActions('S_DELETE_WEBVIEW',null,{webviewID:O[Y]});this.getSimulatorActions('S_CHANGE_CURRENT_WEBVIEW',null,{webviewID:N})}),S.style.transform=`translate3d(${T}px,0,0)`})})}},_getOpenWebviewNum:function(){let I=this.state.list,J=1;for(let K in I)I.hasOwnProperty(K)&&I[K]&&!I[K].isTabbar&&J++;return J},_openNewWebview:function(I,J=()=>{}){let{webviewID:K,url:L,isMap:M,type:N}=I;if(!I.isMap&&5<this._getOpenWebviewNum())return void J(-1);let O=this.state.appJSON,P={},Q=D;if(!M){try{P=v.getPageJSONSync(this.props.project,L)}catch(S){}Q=P.backgroundColor||O.window.backgroundColor||D}let R=this.setAnimateImg(!0,{color:Q});R.style.transform='translate3d(0,0,0)',R.addEventListener('transitionend',()=>{R.parentNode.removeChild(R),E++;let S=Object.assign({},this.state.list);S[E]={prevWebviewID:K,href:L,pageJSON:P,isMap:M,type:N},this.setState({currentWebviewID:E,list:S}),this.getSimulatorActions('S_CHANGE_CURRENT_WEBVIEW',null,{webviewID:E}),J(null,E)})},_openNewWindowWebview:function(I){let J=I.url,K=this.getRouteName(J),L={},M=this.props.project;try{L=v.getPageJSONSync(M,J)}catch(U){}L.backgroundColor||'#ffffff';let N=k.getBaseURL(M);J=t.resolve(N,`${J}.html`);let O=Object.assign({},this.state.list),P={},Q={};for(let U in O){let V=O[U];V.isTabbar&&(V.isTabbar===K&&(Q.currentWebviewID=U),P[U]=V)}Q.list=P;let R=!1;void 0===Q.currentWebviewID&&(Q.currentWebviewID=++E,Q.list[E]={showUrl:!1,hideBack:!0,isTabbar:K,href:J,pageJSON:L,type:'switchTab'},R=!0);let S=Q.currentWebviewID,T=Q.currentWebviewID!=this.state.currentWebviewID;return this.setState(Q,()=>{setTimeout(()=>{!R&&T&&this.postAppRoute(J,S,'switchTab'),this.getSimulatorActions('S_CHANGE_CURRENT_WEBVIEW',null,{webviewID:S})},0)}),S},_changeWebviewID:function(I){this.setState({currentWebviewID:I})},_setWebviewInfo:function(I){let J=this.state.tabBar;J.list||[],I.height&&this.setState({offset:{height:I.height,width:I.width,dpr:I.dpr}})},_setWebviewSnapshot:function(I,J){let K=Object.assign({},this.state.list);K[I].dataURI=J,this.setState({list:K})},_postMessageToAllWebview:function(I){let J=I.webviewIds||[],K=0===J.length;setTimeout(()=>{I.act='sendMsgFromAppService';let L;L=K?Object.keys(this.state.list):J,L.forEach(M=>{this.getSimulatorActions('S_SET_ACTION',M,I)})},17)},_getShortUrl:function(I){let J='';if(this.props.project){let K=this.props.project;J=k.getBaseURL(K)}return I.replace(J,'')},navigateTo:function(I,J){let K=I.args.url,L=this.getTabPageIndex(this.getRouteName(K));if(0<=L)return void J({errMsg:'navigateTo:fail can not navigate to tabBar page'});let M=this.state.currentWebviewID;this._openNewWebview({webviewID:M,url:K,type:'navigateTo'},(N,O)=>{null===N?J({errMsg:'navigateTo:ok',url:this._getShortUrl(K),webviewId:O}):J({errMsg:'navigateTo:fail webview count limit exceed.'})})},redirectTo:function(I,J){let K=I.args.url,L=this.getTabPageIndex(this.getRouteName(K));if(0<=L)return void J({errMsg:'redirectTo:fail can not redirect to tabBar page'});let M={};try{M=v.getPageJSONSync(this.props.project,K)}catch(T){}let N=this.state.currentWebviewID,O=Object.assign({},this.state.list),P=O[N],Q=P.isTabbar,R=P.prevWebviewID;delete O[N],E++,O[E]={pageJSON:M,prevWebviewID:R,href:K,hideBack:Q||N===this.state.topWebviewID,type:'redirectTo'};let S={currentWebviewID:E};1==Object.keys(O).length&&(S.topWebviewID=E),Q?(S.list={},S.list[E]=O[E],S.topWebviewID=E):S.list=O,this.setState(S),setTimeout(()=>{this.getSimulatorActions('S_CHANGE_CURRENT_WEBVIEW',null,{webviewID:E})}),J({errMsg:'redirectTo:ok',url:this._getShortUrl(K),webviewId:N})},switchTab:function(I,J){let K=this.getTabPageIndex(this.getRouteName(I.args.url));if(0>K)return void J({errMsg:'switchTab:fail can not switch to no-tabBar page'});let L=this._openNewWindowWebview({url:this.getRouteName(I.args.url)});J({errMsg:'switchTab:ok',webviewId:L,url:this._getShortUrl(I.args.url)})},_asSdk:function(I,J,K){if('redirectTo'===I)this.redirectTo(J,K);else if('navigateTo'===I)this.navigateTo(J,K);else if('switchTab'===I)this.switchTab(J,K);else if('navigateBack'===I){let M=this.state.currentWebviewID,N=c.findDOMNode(this.refs[`webview${M}`]),O=N.querySelector(`.webviewbody${M}`);this.goBack(this.state.currentWebviewID,O,!1,J.args.delta||1),setTimeout(()=>{K({errMsg:'navigateBack:ok',url:this._getShortUrl(O.src)})},200)}else if('setNavigationBarTitle'===I)setTimeout(()=>{let M=this.state.currentWebviewID,N=J.args;this.getSimulatorActions('S_SET_WEBVIEW_MARGIN',M,{name:I,value:N.title||''}),K({errMsg:'setNavigationBarTitle:ok'})},400);else if('showNavigationBarLoading'===I){let M=this.state.currentWebviewID;J.args,setTimeout(()=>{this.getSimulatorActions('S_SET_WEBVIEW_MARGIN',M,{name:I}),K({errMsg:`${I}:ok`})},0)}else if('hideNavigationBarLoading'===I){let M=this.state.currentWebviewID;J.args,setTimeout(()=>{this.getSimulatorActions('S_SET_WEBVIEW_MARGIN',M,{name:I}),K({errMsg:`${I}:ok`})},0)}else if('chooseLocation'===I){let M=this.state.currentWebviewID,N=J.url;this._openNewWebview({isMap:!0,webviewID:M,url:N});let O={};this.chooseLocation=function(P){return P?void(O=P):void(0===Object.keys(O).length?K({errMsg:'chooseLocation:fail'}):K({name:O.poiname,address:O.poiaddress,latitude:O.latlng.lat,longitude:O.latlng.lng,errMsg:'chooseLocation:ok'}))},this.closeLocation=function(){K({errMsg:'chooseLocation:cancel'})}}else if('openLocation'===I){let M=this.state.currentWebviewID;this._openNewWebview({isMap:!0,webviewID:M,url:J.url}),K({errMsg:'openLocation:ok'})}else if('operateWXData'===I){let M='',N=J.args;if(this.props.project){let O=this.props.project;M=O.appid}p({url:`${u.jsOperateWXDATAURL}?appid=${M}`,method:'post',body:JSON.stringify({data:JSON.stringify(N.data||{})}),needToken:1},(O,P,Q)=>{let R={},S='';if(!O&&200===P.statusCode&&(Q=JSON.parse(Q),Q.baseresponse))if(0==Q.baseresponse.errcode)try{R.data=JSON.parse(Q.data),R.errMsg='operateWXData:ok'}catch(U){R.errMsg='operateWXData:fail'}else{if(-12000==Q.baseresponse.errcode){var T=F++;let U=(V,W,X)=>{R.errMsg=X?'operateWXData:ok':'operateWXData:cancel';let Y=W[0];if(X&&Y.checked){let Z={data:JSON.stringify(N.data||{}),grant_scope:Y.scope};p({url:`${u.jsOperateWXDATAURL}?appid=${M}`,method:'post',body:JSON.stringify(Z),needToken:1},($,_,aa)=>{let ba={};if(!$&&200===_.statusCode&&(aa=JSON.parse(aa),aa.baseresponse&&0===aa.baseresponse.errcode))try{ba.data=JSON.parse(aa.data),ba.errMsg='operateWXData:ok'}catch(ca){ba.errMsg='operateWXData:fail'}ba.errMsg||(ba.errMsg='operateWXData:fail; '),K(ba)})}else K(R);l.removeListener('AUTHORIZE_SDK_RETURN_'+V,U)};return l.on('AUTHORIZE_SDK_RETURN_'+T,U),void this.getSimulatorActions('S_AUTHORIZE_SDK',this.state.currentWebviewID,{authorizeSdkId:T,url:`${Q.appicon_url}/0`,appname:Q.appname,scope_list:[Q.scope]})}S=Q.baseresponse.errmsg}R.errMsg||(R.errMsg='operateWXData:fail '+S),K(R)})}else if('authorize'===I){let M='';if(this.props.project){let P=this.props.project;M=P.appid}let N=J.args,O={scope:N.scope||[]};p({url:`${u.jsAuthorizeURL}?appid=${M}`,method:'post',body:JSON.stringify(O),needToken:1},(P,Q,R)=>{let S={},T='';if(!P&&200===Q.statusCode&&(R=JSON.parse(R),R.baseresponse))if(S.body=R,0==R.baseresponse.errcode)S.errMsg='authorize:ok';else{if(-12000==R.baseresponse.errcode){var U=F++;let V=(W,X,Y)=>{if(S.errMsg=Y?'authorize:ok':'authorize:cancel',Y){let Z=[];for(let $=0;$<X.length;++$){let _=X[$];!_.checked||Z.push(_.scope)}console.log(X),p({url:`${u.jsAuthorizeConfirmURL}?appid=${M}`,method:'post',body:JSON.stringify({scope:Z}),needToken:1},($,_,aa)=>{let ba={};$||200!==_.statusCode||(aa=JSON.parse(aa),aa.baseresponse&&0===aa.baseresponse.errcode&&(ba.errMsg='authorize:ok')),ba.errMsg||(ba.errMsg='authorize:fail'),K(ba)})}else K(S);l.removeListener('AUTHORIZE_SDK_RETURN_'+W,V)};return l.on('AUTHORIZE_SDK_RETURN_'+U,V),void this.getSimulatorActions('S_AUTHORIZE_SDK',this.state.currentWebviewID,{authorizeSdkId:U,url:`${R.appicon_url}/0`,appname:R.appname,scope_list:R.scope_list})}T=R.baseresponse.errmsg}S.errMsg||(S.errMsg='authorize:fail '+T),K(S)})}else if('getSystemInfo'===I||'getSystemInfoSync'===I){let M=this.state.currentWebviewID,N=l.getInfo(),O=this.state.list[M],P=N.os;K({errMsg:`${I}:ok`,model:N.model,pixelRatio:N.dpr,windowWidth:N.width,windowHeight:-1<this.getTabPageIndex(O.href)?N.height-C:N.height,system:'iOS'===P?'iOS 10.0.1':'Android 5.0',language:'zh_CN',version:'6.3.9'})}else if('showShareMenu'===I){let M=Object.assign({},this.state.shareBtnShow);M[this.state.currentWebviewID]=!0,K({errMsg:'showShareMenu:ok'}),this.setState({shareBtnShow:M})}else if('shareAppMessage'===I){let M=J.args,N=c.findDOMNode(this.refs[`webview${this.state.currentWebviewID}`]),O=N.querySelector(`.webviewbody${this.state.currentWebviewID}`);O.captureVisibleRegion(P=>{let Q={show:!0,title:M.title,desc:M.desc,imgUrl:M.imgUrl,dataURI:P,callback:K};this.setState({share:Q})})}else if('requestPayment'===I){this.setState({uuid:J.uuid,qrcode:J.qrcode});let M=this.props.project,N=M.appid;this.requestPaymentCallBack=K;var L=()=>{p({url:`${u.paymentStateURL}?appid=${N}`,loginForc:1,needToken:1,method:'post',body:JSON.stringify({wxa_pay_uuid:J.uuid})},(O,P,Q)=>{if(O)m.showTipsMsg({msg:JSON.stringify(O),type:'error'});else{let R;try{R=JSON.parse(Q)}catch(U){return a(`系统错误 ${JSON.stringify(U)}`),o.error(`controller.js payment parse body error: ${Q} ${JSON.stringify(O)}`),void K({errMsg:`requestPayment:fail`})}let S=R.baseresponse,T=S?parseInt(S.errcode):0;if(0===T){let U=parseInt(R.qrcode_state);if(4===U||3===U)return this.state.uuid&&(G=setTimeout(L,3000)),void this.setState({qrcodeState:U});if(5===U){let V=JSON.parse(R.payment_ret);return V.errMsg=V.err_msg.replace(/^get_brand_wcpay_request/,'requestPayment'),delete V.err_msg,K(V),void this.setState({qrcode:'',uuid:'',qrcodeState:''})}1===U?a(`UUID 错误`):2===U?a(`等待超时，请重试`):a(`系统错误 错误码 ${U}`),K({errMsg:`requestPayment:fail`})}else a(`系统错误，错误码 ${T}，错误信息 ${S.errmsg}`)}})};L()}},_upWebviewStatus:function(I,J){this.upCurrentWebviewURL(J.url)},_toggleRecordWording:function(I){this.setState({showRecordWording:I})},getTabPageIndex:function(I,J){let K=k.getFileNameFromUrl(I,this.props.project).replace(/\.wxml$/,'');J=J||this.state.tabBar;let L=J.list||[],M=L.findIndex(N=>{return N.pagePath===K});return M},upCurrentWebviewURL:function(I){},getSimulatorActions:function(I,J,K){let L={currentWebviewID:this.state.currentWebviewID};if(q(I,J,K,L),'S_CHANGE_CURRENT_WEBVIEW'===I){let M=K.webviewID;if(M===this.state.currentWebviewID){let N=c.findDOMNode(this.refs[`webview${M}`]),O=N.querySelector('webview'),P=O.src;this.upCurrentWebviewURL(P),m.changeUrl(P,M)}}},projectHasTab:function(){let I=this.state.tabBar.list||[],J=I.length;return J&&5>=I.length&&2<=I.length},closePayment:function(){this.requestPaymentCallBack&&this.requestPaymentCallBack({errMsg:'requestPayment:cancel'}),clearTimeout(G),this.setState({uuid:'',qrcode:''})},componentDidMount:function(){l.on('CHANGE_WEBVIEW_ID',this._changeWebviewID),l.on('SET_WEBVIEW_INFO',this._setWebviewInfo),l.on('AS_PUBLISH',this._postMessageToAllWebview),l.on('SEND_AS_SDK',this._asSdk),l.on('SET_WEBVIEW_SNAPSHOT',this._setWebviewSnapshot),l.on('UP_WEBVIEW_STATUS',this._upWebviewStatus),l.on('TOGGLE_RECORD_WORDING',this._toggleRecordWording);let I=this.props.project?1:12;chrome.fontSettings.setMinimumFontSize({pixelSize:I})},componentWillUnmount:function(){l.removeListener('CHANGE_WEBVIEW_ID',this._changeWebviewID),l.removeListener('SET_WEBVIEW_INFO',this._setWebviewInfo),l.removeListener('AS_PUBLISH',this._postMessageToAllWebview),l.removeListener('SEND_AS_SDK',this._asSdk),l.removeListener('SET_WEBVIEW_SNAPSHOT',this._setWebviewSnapshot),l.removeListener('UP_WEBVIEW_STATUS',this._upWebviewStatus),l.removeListener('TOGGLE_RECORD_WORDING',this._toggleRecordWording)},chooseLocation:function(){},closeLocation:function(){},hideShare:function(){this.setState({share:{show:!1}})},render:function(){let I=[];for(let K in this.state.list){let L=K==this.state.currentWebviewID?{}:n.webviewDisplayNone,M=this.state.list[K],N=this.getTabPageIndex(M.href),O=null,P=null,Q=Object.assign({},this.state.offset);if(this.projectHasTab()&&-1<N){let R=this.state.tabBar.position,S={width:this.state.offset.width,margin:'0 auto'},T=b.createElement('div',{style:S},b.createElement(f,{webviewID:K,tabPageIndex:N,project:this.props.project,_openNewWindowWebview:this._openNewWindowWebview,tabBar:this.state.tabBar}));'top'===R?O=T:P=T,Q.height=Q.height-C}I.push(b.createElement('div',{key:K,style:L},b.createElement('div',{className:'simulator-shadow',style:{width:Q.width}},b.createElement(j,{showRecordWording:this.state.showRecordWording,type:M.type,ref:`webview${K}`,webviewID:K,project:this.props.project,offset:Q,isTabWebview:-1<N,href:M.href,pageJSON:M.pageJSON,appJSON:this.state.appJSON,isMap:M.isMap,chooseLocation:this.chooseLocation,closeLocation:this.closeLocation,hideBack:!!M.hideBack,goBack:this.goBack,getSimulatorActions:this.getSimulatorActions,postAppRoute:this.postAppRoute,topTabDom:O,shareBtnShow:this.state.shareBtnShow[K]}),P)))}let J=this.props.project?b.createElement(g,{share:this.state.share,hideShare:this.hideShare}):null;return b.createElement('div',{className:'simulator-wrapper'},b.createElement(d,{getSimulatorActions:this.getSimulatorActions,list:this.state.list,currentWebviewID:this.state.currentWebviewID,project:this.props.project,show:this.props.show}),b.createElement('div',{className:'simulator-list-wrapper',style:{width:this.state.offset.width}},J,I,b.createElement(z,{webviewID:this.state.currentWebviewID}),b.createElement(x,{project:this.props.project,webviewID:this.state.currentWebviewID}),b.createElement(w,{webviewID:this.state.currentWebviewID}),b.createElement(A,{webviewID:this.state.currentWebviewID}),b.createElement(y,{webviewID:this.state.currentWebviewID}),b.createElement(B,{width:this.state.offset.width,project:this.props.project}),b.createElement(s,{uuid:this.state.uuid,qrcode:this.state.qrcode,closePayment:this.closePayment})),b.createElement(r,null))}});_exports=H}init(),module.exports=_exports;