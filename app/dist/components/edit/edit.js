'use strict';var _exports;function init(){function a(F){return F.replace(/\\/g,'/')}function b(F){return{mtime:+F.mtime,birthtime:+F.birthtime,isDir:F.isDirectory(),size:F.size}}const c=require('glob'),d=require('fs'),f=require('path'),g=require('url'),h=require('rmdir'),j=require('../../lib/react.js'),k=require('../../cssStr/cssStr.js');require('../../actions/webviewActions.js');const l=require('../../actions/windowActions.js'),m=require('../../stores/windowStores.js');require('../../actions/projectActions.js');const n=require('../../weapp/utils/tools.js'),o=require('../../weapp/utils/projectManager.js'),q=require('../../stores/projectStores.js'),r=require('../../common/log/log.js'),{spawn:t,spawnSync:u,exec:v}=require('child_process'),w=require('./utils/editTools.js'),x=require('./utils/grep.js'),y=require('./utils/formatCode.js');var z={},A=!1;'win32'===process.platform;const B={'.jpg':!0,'.png':!0,'.jpeg':!0,'.icon':!0,'.gif':!0},C=function(F){l.showTipsMsg({msg:F,type:'error'})},D=function(F,G){l.showConfirm({content:F,callback:G})},E=j.createClass({displayName:'Edit',getInitialState:function(){return{project:this.props.project}},onMessage:function(F){let G=F.command,H=F.msg,I=F.ext,J=this.state.project;switch(G){case'GET_FILE_LIST':{if(A)return;A=!0;let K=H.options,L=K.ignore||['node_modules/**/*','node_modules'];c(`**`,{cwd:J.projectpath,ignore:L},(M,N)=>{A=!1;let O={ret:M?M.toString():0,res:{files:M?[]:N,info:{}}};for(let P=0;P<N.length;P++){let Q=N[P],R=f.join(J.projectpath,Q),S=d.lstatSync(R),T=S.isDirectory();T&&(N[P]=`${Q}/`),O.res.info[N[P]]=b(S)}N.forEach(P=>{z[P]=!0}),this.postMessage('webframe','RETURN_RES',O,I)});break}case'GET_FILE_DATA':{let K=H.path,L=f.extname(K);if(B[L]){let M='';try{M=decodeURI(g.resolve(n.getBaseURL(J),K))}catch(N){M=g.resolve(n.getBaseURL(J),K)}this.postMessage('webframe','RETURN_RES',{ret:0,res:{data:M}},I)}else{let M=f.join(J.projectpath,K);d.readFile(M,'utf8',(N,O)=>{let P=d.lstatSync(M),Q=b(P),R={ret:N?N.toString():0,res:{data:N?'':O,info:Q}};this.postMessage('webframe','RETURN_RES',R,I)})}break}case'SAVE_FILE_DATA':{let K=f.join(J.projectpath,H.path),L=H.data,M;try{d.writeFileSync(K,L,'utf8');let N=d.lstatSync(K),O=+N.mtime;if(z[a(H.path)]=O,M={ret:0,res:{path:H.path,info:b(N)}},'app.json'===H.path)try{let P=JSON.parse(L),Q=P.pages||[];w.initPage(J,Q)}catch(P){}}catch(N){M={ret:N.toString(),res:''}}this.postMessage('webframe','RETURN_RES',M,I);break}case'DEL_FILE':{let K=H.path,L;try{d.unlinkSync(f.join(J.projectpath,K)),K=a(K),L={ret:0,res:K},delete z[K]}catch(M){L={ret:M.toString(),res:''}}this.postMessage('webframe','RETURN_RES',L,I);break}case'RENAME_FILE':{let K=f.join(J.projectpath,H.oldPath),L=f.join(J.projectpath,H.newPath),M,N=d.lstatSync(K);if(N.isDirectory()){o.manager.stopWatch();let O='darwin'===process.platform?'mv':'ren',P='darwin'===process.platform?[`"${K}"`,`"${L}"`]:[`"${K}"`,`"${f.relative(f.dirname(L),L)}"`],Q=[],R=[],S=t(O,P,{shell:!0});S.on('close',T=>{o.manager.restartWatch(),M=0===T?{ret:0,res:{path:H.newPath,info:b(N)}}:{ret:'\u76EE\u5F55\u4FEE\u6539\u9519\u8BEF',res:''},this.postMessage('webframe','RETURN_RES',M,I)}),S.stdout.on('data',T=>{Q.push(T)}),S.stderr.on('data',T=>{R.push(T)})}else{try{d.renameSync(K,L),delete z[a(H.oldPath)];let O=d.lstatSync(L);z[H.newPath]=!0,M={ret:0,res:{path:H.newPath,info:b(O)}}}catch(O){M={ret:O.toString(),res:''}}this.postMessage('webframe','RETURN_RES',M,I)}break}case'RM_DIR':{let K=J.projectpath,L=f.join(K,H.path);h(L,(M,N,O)=>{M||(N.forEach(Q=>{let R=f.relative(K,Q);R=a(R),delete z[R]}),O.forEach(Q=>{let R=f.relative(K,Q);R=a(R),delete z[R]}));let P={ret:M?M.toString():0,res:M?'':N};this.postMessage('webframe','RETURN_RES',P,I)});break}case'ADD_FILE':{let K=f.join(J.projectpath,H.path),L=d.existsSync(K),M;if(L)M={ret:`${H.path} already existed`},this.postMessage('webframe','RETURN_RES',M,I);else{try{d.writeFileSync(K,'','utf8'),z[a(H.path)]=!0;let N=d.lstatSync(K);M={ret:0,res:{path:H.path,info:b(N)}}}catch(N){M={ret:N.toString(),res:''}}this.postMessage('webframe','RETURN_RES',M,I)}break}case'MAKE_DIR':{let K=f.join(J.projectpath,H.path),L;try{d.mkdirSync(K),z[a(H.path)]=!0;let M=d.lstatSync(K);L={ret:0,res:{path:K,info:b(M)}}}catch(M){L={ret:M.toString(),res:''}}this.postMessage('webframe','RETURN_RES',L,I);break}case'GET_PROJECT_INFO':{this.postMessage('webframe','RETURN_RES',{ret:0,res:J},I);break}case'SET_EDIT_WEBVIEW':{let K=H.editWebview;q.setProjectEditWebview(J.hash,K),this.postMessage('webframe','RETURN_RES',{ret:0,res:K},I);break}case'FIND_STR':{let{options:K,str:L}=H,{cwd:M,i:N,wholeword:O}=K;M=f.join(J.projectpath,M),x({str:L,cwd:M,i:N,wholeword:O,project:J},(P,Q)=>{let R={};P?R.ret=JSON.stringify(P):(R.ret=0,R.res=Q),this.postMessage('webframe','RETURN_RES',R,I)});break}case'SHOW_ITEM_IN_FOLDER':{let K=f.join(J.projectpath,H.filePath);nw.Shell.showItemInFolder(K);break}case'FORMAT_CODE':{let{code:K,options:L}=H;y(K,L,(M,N)=>{this.postMessage('webframe','RETURN_RES',{ret:0,res:N},I)});break}}},postMessage:function(F,G,H,I){let J={to:F,msg:H,command:G,ext:I};if(!this.port)return void this.msgQuery.push(J);this.msgQuery.length&&(this.msgQuery.forEach(K=>{this.port.postMessage(K)}),this.msgQuery=[]);this.port.postMessage(J)},initport:function(F){'edit'===F.name&&(this.port=F,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(()=>{this.port.onMessage.removeListener(this.onMessage),delete this.port,delete this.portID,this.msgQuery=[]}),this.postMessage('contentscript','SHAKE_HANDS',{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:'contentscript',matches:['<all_urls>'],js:{files:['app/dist/contentscript/editcontent.js']},run_at:'document_start'}])},ewWindow:function(){this.webview.addEventListener('newwindow',function(F){let G=F.targetUrl;G&&nw.Window.open(G,{width:799,height:799})})},_windowFocus:function(){'focus'===this.currentStatus||(this.postMessage('webframe','WINDOW_CHANGE',{eventType:'focus'},{}),setTimeout(()=>{this.webview.focus()},100),this.currentStatus='focus')},_windowBlur:function(){'blur'===this.currentStatus||(this.postMessage('webframe','WINDOW_CHANGE',{eventType:'blur'},{}),this.currentStatus='blur')},_editWebview:function(F,G){F.hash===this.props.project.hash&&this.postMessage('webframe','WEBVIEW_SHOW_CHANGE',{editWebview:G},{})},_openProjectFile:function(F){this.postMessage('webframe','OPEN_FILE',F,{})},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;let F=this.refs.container,G=this.webview=document.createElement('webview');G.className=`simulator-bd-webview_body`,G.setAttribute('partition','persist:trusted'),G.setUserAgentOverride(`${G.getUserAgent()} devtoolsedit`),F.appendChild(G),this.ewWindow(),this.addContentScripts(),this.initRuntime(),G.addEventListener('dialog',I=>{let J=I.messageType||'',K=I.messageText,L=I.dialog;if('alert'===J)C(K);else if('confirm'===J)I.preventDefault(),D(K,M=>{M?L.ok():L.cancel()});else if('prompt'===J){let M=prompt(K);null===M?L.cancel():L.ok(M)}});let H=o.manager;H.on('FILE_CHANGE',this._initWatcher),G.src='app/html/edit.html',m.on('WINDOW_BLUR',this._windowFocus),m.on('WINDOW_FOCUS',this._windowBlur),q.on('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',this._editWebview),m.on('OPEN_PROJECT_FILE',this._openProjectFile)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),m.removeListener('WINDOW_BLUR',this._windowFocus),m.removeListener('WINDOW_FOCUS',this._windowBlur),q.removeListener('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',this._editWebview),m.removeListener('OPEN_PROJECT_FILE',this._openProjectFile);let F=o.manager;F.removeListener('FILE_CHANGE',this._initWatcher),this.webview.remove(),z={}},_initWatcher:function(F,G,H,I){if(F.hash===this.state.project.hash){let N=I?+I.mtime:0,O=I?b(I):{},S={};H=a(H),f.join(F.projectpath,H);let T=z[H];if('unlinkDir'===G&&(T=z[`${H}/`]),('add'===G||'addDir'===G)&&!T)S={eventType:G,fileName:H,info:O};else if(('unlink'===G||'unlinkDir'===G)&&T)S={eventType:G,fileName:H,info:O},delete z[H];else if('change'===G){if(z[H]===N)return;z[H]=N,S={eventType:G,fileName:H,info:O}}else return void r.info(`edit.js watch ${G}`);this.postMessage('webframe','FILE_CHANGE',S,{})}},componentWillReceiveProps:function(F){'edit'===F.show?this._windowFocus():this._windowBlur()},render:function(){const{show:F,project:G}=this.props;let H='edit'===F?{}:k.displayNone;return j.createElement('div',{className:'edit',ref:'container',style:H})}});_exports=E}init(),module.exports=_exports;