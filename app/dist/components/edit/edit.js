"use strict";function init(){function e(e){return e=e.replace(/\\/g,"/"),"/"===e[0]?e:"/"+e}function t(e){return{mtime:+e.mtime,birthtime:+e.birthtime,isDir:e.isDirectory(),size:e.size}}function r(e){try{return s.lstatSync(e)}catch(e){return{isDirectory:function(){return!1}}}}var i=require("glob"),s=require("fs"),n=require("path"),o=require("url"),a=require("rmdir"),c=require("../../lib/react.js"),p=require("../../cssStr/cssStr.js"),h=(require("../../actions/webviewActions.js"),require("../../actions/windowActions.js")),u=require("../../stores/windowStores.js"),d=require("../../actions/projectActions.js"),E=require("../../weapp/utils/tools.js"),f=require("../../weapp/utils/projectManager.js"),_=require("../../stores/projectStores.js"),m=require("../../common/log/log.js"),l=require("child_process"),w=l.spawn,v=(l.spawnSync,l.exec,require("./utils/editTools.js")),g=require("./utils/grep.js"),R=require("./utils/formatCode.js"),S=require("./config/config.js"),b=S.pageJS,j=S.pageJSON,I=S.pageWXML,N=S.pageWXSS,T={".js":b,".wxml":I,".json":j,".wxss":N},D={},A=!1,O=("win32"===process.platform,{".jpg":!0,".png":!0,".jpeg":!0,".icon":!0,".gif":!0,".svg":!0,".cer":!0}),L=function(e){h.showTipsMsg({msg:e,type:"error"})},M=function(e,t){h.showConfirm({content:e,callback:t})},y=c.createClass({displayName:"Edit",getInitialState:function(){return{project:this.props.project}},onMessage:function(c){var p=this,h=c.command,m=c.msg,l=c.ext,S=this.state.project;switch(h){case"GET_FILE_LIST":if(A)return;A=!0;var b=m.options,j=b.ignore||["node_modules/**/*","node_modules"];i("**",{cwd:S.projectpath,ignore:j,nosort:!0,strict:!1,silent:!0},function(e,i){A=!1;for(var s={ret:e?e.toString():0,res:{files:e?[]:i,info:{}}},o=0;o<i.length;o++){var a=i[o],c=n.join(S.projectpath,a),h=r(c),u=h.isDirectory();u&&(i[o]=a+"/"),i[o]="/"+i[o],s.res.info[i[o]]=t(h)}i.forEach(function(e){D[e]=!0}),s.res.projectpath=S.projectpath,p.postMessage("webframe","RETURN_RES",s,l)});break;case"GET_FILE_DATA":var I=m.path,N=n.extname(I);if(O[N]){var L="";try{L=decodeURI(o.resolve(E.getBaseURL(S),I))}catch(e){L=o.resolve(E.getBaseURL(S),I)}this.postMessage("webframe","RETURN_RES",{ret:0,res:{data:L}},l)}else{var M=n.join(S.projectpath,I);s.readFile(M,"utf8",function(e,i){var s=r(M),n=t(s),o={ret:e?e.toString():0,res:{data:e?"":i,info:n}};p.postMessage("webframe","RETURN_RES",o,l)})}break;case"SAVE_FILE_DATA":var y=n.join(S.projectpath,m.path),C=m.data,F=void 0;try{_.emit("FILE_CHANGE_FROM_EDITOR"),s.writeFileSync(y,C,"utf8");var W=s.lstatSync(y),U=+W.mtime;if(D[e(m.path)]=U,F={ret:0,res:{path:m.path,info:t(W)}},"/app.json"===m.path)try{var P=JSON.parse(C),k=P.pages||[];v.initPage(S,k)}catch(e){}}catch(e){F={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",F,l);break;case"DEL_FILE":var G=m.path,q=void 0;try{_.emit("FILE_CHANGE_FROM_EDITOR"),s.unlinkSync(n.join(S.projectpath,G)),G=e(G),q={ret:0,res:G},delete D[G]}catch(e){q={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",q,l);break;case"RENAME_FILE":var H=n.join(S.projectpath,m.oldPath),B=n.join(S.projectpath,m.newPath),x=void 0,J=r(H);if(_.emit("FILE_CHANGE_FROM_EDITOR"),J.isDirectory()){f.manager.stopWatch();var V="darwin"===process.platform?"mv":"ren",Q="darwin"===process.platform?['"'+H+'"','"'+B+'"']:['"'+H+'"','"'+n.relative(n.dirname(B),B)+'"'],X=[],z=[],K=w(V,Q,{shell:!0});K.on("close",function(e){f.manager.restartWatch(),x=0===e?{ret:0,res:{path:m.newPath,info:t(J)}}:{ret:"目录修改错误",res:""},p.postMessage("webframe","RETURN_RES",x,l)}),K.stdout.on("data",function(e){X.push(e)}),K.stderr.on("data",function(e){z.push(e)})}else{try{s.renameSync(H,B),delete D[e(m.oldPath)];var Y=s.lstatSync(B);D[m.newPath]=!0,x={ret:0,res:{path:m.newPath,info:t(Y)}}}catch(e){x={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",x,l)}break;case"RM_DIR":var Z=S.projectpath,$=n.join(Z,m.path);_.emit("FILE_CHANGE_FROM_EDITOR"),a($,function(t,r,i){t||(r.forEach(function(t){var r=n.relative(Z,t);r=e(r),delete D[r]}),i.forEach(function(t){var r=n.relative(Z,t);r=e(r),delete D[r]}));var s={ret:t?t.toString():0,res:t?"":r};p.postMessage("webframe","RETURN_RES",s,l)});break;case"ADD_FILE":var ee=n.join(S.projectpath,m.path),te=s.existsSync(ee),re=void 0;if(te)re={ret:m.path+" already existed"},this.postMessage("webframe","RETURN_RES",re,l);else{try{_.emit("FILE_CHANGE_FROM_EDITOR"),s.writeFileSync(ee,"","utf8"),D[e(m.path)]=!0;var ie=s.lstatSync(ee);re={ret:0,res:{path:m.path,info:t(ie)}}}catch(e){re={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",re,l)}break;case"ADD_PAGE":var se=n.join(S.projectpath,m.path),ne=m.name,oe={ret:0,res:[]},ae=!1;for(var ce in T){var pe=n.join(se,""+ne+ce);if(!s.existsSync(pe)){var he=T[ce].replace(/{{page}}/g,ne);try{_.emit("FILE_CHANGE_FROM_EDITOR"),s.writeFileSync(pe,he,"utf8"),D[e(pe)]=!0;var ue=s.lstatSync(se);oe.res.push({path:e(n.join(m.path,m.name+ce)),info:t(ue)})}catch(e){ae=!0,oe={ret:e.toString(),res:""}}}}if(!ae){var de=n.join(S.projectpath,"app.json"),Ee=JSON.parse(s.readFileSync(de,"utf8"));"/"===m.path[0]&&(m.path=m.path.substr(1));var fe=Ee.pages||[];fe.push(e(n.join(m.path,m.name))),Ee.pages=fe;try{s.writeFileSync(de,JSON.stringify(Ee,null,parseInt(u.getEditorConfig("tabSize"))),"utf8")}catch(e){ae=!0,oe={ret:e.toString(),res:""}}}this.postMessage("webframe","RETURN_RES",oe,l);break;case"MAKE_DIR":var _e=n.join(S.projectpath,m.path),me=void 0;try{_.emit("FILE_CHANGE_FROM_EDITOR"),s.mkdirSync(_e),D[e(m.path)]=!0;var le=s.lstatSync(_e);me={ret:0,res:{path:_e,info:t(le)}}}catch(e){me={ret:e.toString(),res:""}}this.postMessage("webframe","RETURN_RES",me,l);break;case"GET_PROJECT_INFO":this.postMessage("webframe","RETURN_RES",{ret:0,res:S},l);break;case"SET_EDIT_WEBVIEW":var we=m.editWebview;_.setProjectEditWebview(S.hash,we),this.postMessage("webframe","RETURN_RES",{ret:0,res:we},l);break;case"FIND_STR":var ve=m.options,ge=m.str,Re=ve.cwd,Se=ve.i,be=ve.wholeword;Re=n.join(S.projectpath,Re),g({str:ge,cwd:Re,i:Se,wholeword:be,project:S},function(e,t){var r={};e?r.ret=JSON.stringify(e):(r.ret=0,r.res=t),p.postMessage("webframe","RETURN_RES",r,l)});break;case"SHOW_ITEM_IN_FOLDER":var je=n.join(S.projectpath,m.filePath);nw.Shell.showItemInFolder(je);break;case"FORMAT_CODE":var Ie=m.code,Ne=m.options;R(Ie,Ne,function(e,t){var r={ret:0,res:t};p.postMessage("webframe","RETURN_RES",r,l)});break;case"REBUILD":d.restartImmediate(m);break;case"SET_CLIPBOARD":nw.Clipboard.get().set({data:m.data,type:"text"})}},postMessage:function(e,t,r,i){var s=this,n={to:e,msg:r,command:t,ext:i};return this.port?(this.msgQuery.length&&(this.msgQuery.forEach(function(e){s.port.postMessage(e)}),this.msgQuery=[]),void this.port.postMessage(n)):void this.msgQuery.push(n)},initport:function(e){var t=this;"edit"===e.name&&(this.port=e,this.port.onMessage.addListener(this.onMessage),this.port.onDisconnect.addListener(function(){t.port.onMessage.removeListener(t.onMessage),delete t.port,delete t.portID,t.msgQuery=[]}),this.postMessage("contentscript","SHAKE_HANDS",{}))},initRuntime:function(){chrome.runtime.onConnect.addListener(this.initport)},addContentScripts:function(){this.webview.addContentScripts([{name:"contentscript",matches:["<all_urls>"],js:{files:["app/dist/contentscript/editcontent.js"]},run_at:"document_start"}])},ewWindow:function(){this.webview.addEventListener("newwindow",function(e){var t=e.targetUrl;t&&nw.Window.open(t,{width:799,height:799})})},_windowFocus:function(){var e=this;if("focus"!==this.currentStatus){var t={eventType:"focus"};this.postMessage("webframe","WINDOW_CHANGE",t,{}),setTimeout(function(){e.webview.focus()},100),this.currentStatus="focus"}},_windowBlur:function(){if("blur"!==this.currentStatus){var e={eventType:"blur"};this.postMessage("webframe","WINDOW_CHANGE",e,{}),this.currentStatus="blur"}},_editWebview:function(e,t){e.hash===this.props.project.hash&&this.postMessage("webframe","WEBVIEW_SHOW_CHANGE",{editWebview:t},{})},_openProjectFile:function(e){var t=this,r=u.getLastShow();"edit"===r||this.props.optProject("edit",function(){setImmediate(function(){t.webview.focus(),t.postMessage("webframe","OPEN_FILE",e,{})})})},_updateEditorConfig:function(e){this.postMessage("webframe","UPDATE_EDITOR_CONFIG",e)},_saveAllAndRebuild:function(e){this.postMessage("webframe","SAVE_ALL_AND_REBUILD",e)},_transferEditorCommand:function(e){var t=this;setImmediate(function(){t.webview.focus()}),this.postMessage("webframe","EXEC_EDITOR_COMMAND",e)},componentDidMount:function(){this.msgQuery=[],this.show=this.props.show;var e=this.refs.container,t=this.webview=document.createElement("webview");t.className="simulator-bd-webview_body",t.setAttribute("partition","persist:trusted"),t.setAttribute("tabIndex","-1"),t.setUserAgentOverride(t.getUserAgent()+" devtoolsedit"),e.appendChild(t),this.ewWindow(),this.addContentScripts(),this.initRuntime(),t.addEventListener("dialog",function(e){var t=e.messageType||"",r=e.messageText,i=e.dialog;if("alert"===t)L(r);else if("confirm"===t)e.preventDefault(),M(r,function(e){e?i.ok():i.cancel()});else if("prompt"===t){var s=prompt(r);null!==s?i.ok(s):i.cancel()}}),t.addEventListener("blur",function(e){h.editorBlur()}),t.addEventListener("focus",function(e){h.editorFocus()});var r=f.manager;r.on("FILE_CHANGE",this._initWatcher),t.src="app/html/edit.html",u.on("WINDOW_BLUR",this._windowFocus),u.on("WINDOW_FOCUS",this._windowBlur),_.on("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.on("OPEN_PROJECT_FILE",this._openProjectFile),u.on("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),u.on("EXEC_EDITOR_COMMAND",this._transferEditorCommand),_.on("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild)},componentWillUnmount:function(){chrome.runtime.onConnect.removeListener(this.initport),u.removeListener("WINDOW_BLUR",this._windowFocus),u.removeListener("WINDOW_FOCUS",this._windowBlur),_.removeListener("PROJECT_STORES_CHANGE_EDIT_WEBVIEW",this._editWebview),u.removeListener("OPEN_PROJECT_FILE",this._openProjectFile),u.removeListener("UPDATE_EDITOR_CONFIG",this._updateEditorConfig),u.removeListener("EXEC_EDITOR_COMMAND",this._transferEditorCommand),_.removeListener("SAVE_ALL_AND_REBUILD",this._saveAllAndRebuild);var e=f.manager;e.removeListener("FILE_CHANGE",this._initWatcher),this.webview.remove(),D={}},_initWatcher:function(r,i,s,o){if(r.hash===this.state.project.hash){var a=o?+o.mtime:0,c=o?t(o):{},p={};s=e(s);var h=(n.join(r.projectpath,s),D[s]);if("unlinkDir"===i&&(h=D[s+"/"]),"add"!==i&&"addDir"!==i||h)if("unlink"!==i&&"unlinkDir"!==i||!h){if("change"!==i)return void m.info("edit.js watch "+i);if(D[s]===a)return;D[s]=a,p={eventType:i,fileName:s,info:c}}else p={eventType:i,fileName:s,info:c},delete D[s];else p={eventType:i,fileName:s,info:c};this.postMessage("webframe","FILE_CHANGE",p,{})}},componentWillReceiveProps:function(e){"edit"===e.show?this._windowFocus():this._windowBlur()},render:function(){var e=this.props,t=e.show,r=(e.project,"edit"===t?{}:p.displayNone);return c.createElement("div",{className:"edit",ref:"container",style:r})}});_exports=y}var _exports;init(),module.exports=_exports;