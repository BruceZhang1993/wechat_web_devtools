"use strict";var React=require("../../lib/react.js"),cssStr=require("../../cssStr/cssStr.js"),webviewStores=require("../../stroes/webviewStores.js"),webviewActions=require("../../actions/webviewActions.js"),windowStore=require("../../stroes/windowStores.js"),Autocomplete=require("./Autocomplete.js"),windowActions=require("../../actions/windowActions.js"),timer,webviewNum=0,Urlbar=React.createClass({displayName:"Urlbar",getInitialState:function(){return{webviewID:0,list:{0:{value:""}},disabled:!1,autoIndex:0,isLoading:!1,autocomplete:[],showLoading:!1}},componentDidMount:function(){var t=this;webviewStores.on("CHANGE_WEBVIEW_ID",function(e){t.setState({webviewID:e})}),webviewStores.on("WEBVIEW_SDK",function(e,i,s,a,n){if("openUrlWithExtraWebview"===s){webviewNum++;var o=Object.assign({},t.state.list);o[webviewNum]={value:""},t.setState({webviewID:webviewNum,list:o})}}),webviewStores.on("UP_WEBVIEW_STATUS",function(e,i){/^chrome-extension:\/\//.test(i.url)&&(i.url="about:blank");var s=i.loading,a=t.state.showLoading;"start"===s?a=!0:"stop"===s&&(a=!1);var n=Object.assign({},t.state.list);i.url&&(n[e].value=i.url,delete i.url),Object.assign(t.state,{showLoading:a,list:n},i),t.setState(t.state)}),windowStore.on("FOCUS_ADDRESSBAR",function(e){t.refs.urlinput.select(),t.refs.urlinput.focus()}),windowStore.on("UPDATA_USER_INFO",function(e){e&&setTimeout(function(){t.loadUrl()},0)}),windowStore.on("DISABLE_URLBAR",function(){t.setState({disabled:!0})}),windowStore.on("ABLE_URLBAR",function(){t.setState({disabled:!1})})},loadUrl:function(t){t=t||this.getCurrentUrl(),t=t.trim(),"about:blank"===t?webviewActions.setWebviewAction(this.state.webviewID,{act:"reLoad"}):(windowActions.setAutoComplete(t),webviewActions.getA8keyWebview(this.state.webviewID,{url:t,isSync:!0,from:"urlbar"})),this.setState({autocomplete:[]})},getAutoComplete:function(t){var e=t.trim(),i=(e.replace(/^https?:\/\//,""),[]);return this.props.autocomplete.forEach(function(t){0===t.indexOf(e)&&-1===i.indexOf(t)&&i.push(t)}),i},handleKeyUp:function(t){var e=this,i=t.target,s=t.keyCode;if(13===s)return i.selectionStart=i.value.length,void this.loadUrl();if(40===s||38===s){var a=this.state.autoIndex,n=this.getCurrentUrl(),o=38===s;if(o)a--,0>=a&&(a=0);else{var r=this.state.autocomplete.length;a++,a>=r&&(a=r-1)}var l=Object.assign({},this.state.list),u=this.state.webviewID;l[u].value=a>=0?this.state.autocomplete[a]:n,this.setState({autoIndex:a,list:l}),setTimeout(function(){var t=e.state.webviewID,i=e.state.list[t].value.length;e.refs.urlinput.setSelectionRange(i,i)},1e3/60)}else 8===s&&(i.dataset.changeFrom="backspace")},handleChange:function(t){var e=this,i=t.target,s=i.value,a="backspace"===i.dataset.changeFrom,n=this.getAutoComplete(s),o=Object.assign({},this.state.list),r=this.state.webviewID;if(a)return i.dataset.changeFrom="",o[r].value=s,void this.setState({list:o,autocomplete:n});var l=n[0]&&!a?n[0]:s;o[r].value=l,this.setState({list:o,autocomplete:n},function(){var t=l.indexOf(s)+s.length;t!==l.length&&(e.refs.urlinput.selectionStart=t,e.refs.urlinput.selectionEnd=l.length)})},handleBlur:function(){var t=this;timer=setTimeout(function(){t.setState({autocomplete:[]})},100)},handleFocus:function(){var t=this.getCurrentUrl(),e=this.getAutoComplete(t);this.setState({autocomplete:e})},handleOnClick:function(){webviewActions.setWebviewAction(this.state.webviewID,{act:"reLoad"})},getCurrentUrl:function(){var t=this.state.webviewID;return this.state.list[t].value},autoClick:function(t){clearTimeout(timer);var e=t.currentTarget,i=e.dataset,s=i.index,a=this.state.autocomplete[s],n=Object.assign({},this.state.list);n[this.state.webviewID].value=a,this.setState({list:n,autocomplete:[]}),this.loadUrl(a)},render:function(){var t=this.state.webviewID,e=this.state.list[t].value;return React.createElement("div",{className:"main-header_input"},React.createElement("input",{disabled:this.state.disabled,type:"text",onKeyDown:this.handleKeyUp,onChange:this.handleChange,onBlur:this.handleBlur,onFocus:this.handleFocus,value:e,ref:"urlinput"}),React.createElement("a",{onClick:this.handleOnClick,href:"javascript:;",className:"page_refresh"+(this.state.showLoading?" page_refresh_rotate":"")},React.createElement("img",{src:"../images/refresh.png",alt:"refresh"})),React.createElement(Autocomplete,{autoClick:this.autoClick,autoIndex:this.state.autoIndex,autocomplete:this.state.autocomplete}))}});module.exports=Urlbar;