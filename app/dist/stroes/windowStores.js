"use strict";var EventEmitter=require("events").EventEmitter,log=require("../common/log/log.js"),tools=require("../utils/tools.js"),ADDRESSBAR_HEIGHT=50,LOGVIEW_HEADER_HEIGHT=37,h,currentWebviewID=0,userInfo=JSON.parse(localStorage.getItem("userInfo")),urlConfig={},clientConfig={},autoComplete,setting=JSON.parse(localStorage.getItem("setting"))||{},proxySetting=setting.proxyType||"SYSTEM",Stores=Object.assign({},EventEmitter.prototype,{upSdkErrNum:function(t,e){log.info("windowStores.js upSdkErrNum "+t+" "+e),this.emit("UP_SDK_ERRNUM",t,e)},showTipsMsg:function(t,e){this.emit("SHOW_TIPS_MSG",t,e)},getProxySetting:function(){return proxySetting},updataProxySetting:function(t,e){proxySetting=t,log.info("windowStores.js updataProxySetting "+t);var o=require("../common/proxy/setAppProxy.js");o.up(function(){e()})},getInitInfo:function(){return log.info("windowStores.js getInitInfo "+JSON.stringify(urlConfig)+" "+JSON.stringify(clientConfig)),{urlConfig:urlConfig,clientConfig:clientConfig}},updataInitInfo:function(t,e){var o={urlConfig:t,clientConfig:e};log.info("windowStores.js updataInitInfo "+JSON.stringify(o));var i=tools.hasNewVersion(o);Object.keys(i).length&&tools.notifications("发现新版本","当前版本"+nw.App.manifest.version+"，最新版本"+i.last_version,[{title:"前往下载"}],function(t){0===t&&nw.Shell.openExternal(i.downloadURL)}),this.emit("UPDATA_INIT_INFO",o)},showJSONview:function(t){this.emit("SHOW_JSON_VIEW",t)},showAbout:function(){this.emit("SHOW_ABOUT_LAYER")},showLoginLayer:function(){this.emit("SHOW_LOGIN_LAYER")},getItemH:function(){return h},clearUserInfo:function(t){userInfo=null,localStorage.removeItem("userInfo"),this.emit("UPDATA_USER_INFO",userInfo),this.showLoginLayer(),t&&this.showTipsMsg(t)},getAutoComplete:function(){return autoComplete=JSON.parse(localStorage.getItem("autoComplete"))||[]},setAutoComplete:function(t){autoComplete||(autoComplete=[]);var e=autoComplete.findIndex(function(e){return e===t});-1===e&&-1===t.indexOf("chrome-extension")&&(autoComplete.push(t),localStorage.setItem("autoComplete",JSON.stringify(autoComplete))),this.emit("UPDATA_AUTOCOMPLETE",autoComplete)},getUserInfo:function(){if(userInfo){var t=+new Date;t>userInfo.signatureExpiredTime&&(userInfo=null,localStorage.removeItem("userInfo"))}return log.info("windowStores.js getUserInfo "+JSON.stringify(userInfo)),userInfo},updateUserInfo:function(t){userInfo=t;var e=JSON.stringify(t);localStorage.setItem("userInfo",e),log.info("windowStores.js updateUserInfo "+e),this.emit("UPDATA_USER_INFO",t)},upUserTikcet:function(t,e){userInfo.newticket=t,userInfo.ticketExpiredTime=e,localStorage.setItem("userInfo",JSON.stringify(userInfo)),log.info("windowStores.js upUserTikcet newticket: "+t+" ticketExpiredTime: "+e)},delUserTicket:function(){userInfo.ticketExpiredTime=+new Date-100,localStorage.setItem("userInfo",JSON.stringify(userInfo)),log.info("windowStores.js delUserTicket ticketExpiredTime: "+userInfo.ticketExpiredTime)},resize:function(t){h=t-ADDRESSBAR_HEIGHT-LOGVIEW_HEADER_HEIGHT,this.emit("TOGGLE_SHARE_MENUS",h)},bodyClick:function(t){this.emit("BODY_CLICK",t)},focusAddressBar:function(t){this.emit("FOCUS_ADDRESSBAR",t)},clearAddressHistory:function(t){autoComplete=[],localStorage.setItem("autoComplete",JSON.stringify(autoComplete)),this.emit("UPDATA_AUTOCOMPLETE",autoComplete,t)},showSetting:function(){this.emit("SHOW_SETTING")},changeDevtools:function(){this.emit("CHANGE_DEVTOOLS")},disAbleURLBar:function(){this.emit("DISABLE_URLBAR")},ableURLBar:function(){this.emit("ABLE_URLBAR")}});module.exports=Stores;