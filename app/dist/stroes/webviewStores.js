"use strict";function formatWebviewInfo(e){if(void 0===e.device)webviewUA="iOS"===e.os?config.defaultUa:config.Android_useragent,webviewWidth=375,webviewHeight=627,webviewDpr=2;else{var i=DeviceModules[e.device];webviewUA=i["user-agent"],webviewWidth=i.screen.vertical.width,webviewHeight=i.screen.vertical.height-40,webviewDpr=i.screen["device-pixel-ratio"]}webviewUA=webviewUA.replace("{{version}}",e.version)}var EventEmitter=require("events").EventEmitter,sdk=require("../common/jssdk/sdk.js"),_getA8key=require("../common/getA8key/getA8key.js"),errcodeConfig=require("../config/errcodeConfig.js"),config=require("../config/config.js"),log=require("../common/log/log.js"),DeviceModules=require("../components/setting/DeviceModules.js"),webviewList={},webviewSnapShots={},currentWebviewID=0,webviewUA,webviewWidth=375,webviewHeight=627,webviewDpr=2,initURL="app/html/about.html",setting=JSON.parse(localStorage.getItem("setting"));setting?formatWebviewInfo(setting):webviewUA=config.defaultUa.replace("{{version}}",config.defaultWechatVersion);var Stores=Object.assign({},EventEmitter.prototype,{deleteWebviewID:function(e){log.info("webviewStores.js deleteWebviewID "+e),this.emit("DELETE_WEBVIEW_ID",e)},changeWebviewID:function(e){currentWebviewID=e,log.info("webviewStores.js changeWebviewID "+e),this.emit("CHANGE_WEBVIEW_ID",e)},getSnapShot:function(e){return webviewSnapShots[e]},setSnapShot:function(e,i){webviewSnapShots[e]=i,this.emit("SET_WEBVIEW_SNAPSHOT",e,i)},getInitURL:function(){return initURL},setInitURL:function(e){initURL=e},upErrNum:function(e,i){this.emit("UP_WEBVIEW_ERRNUM",e,i)},getUA:function(){return webviewUA},setUA:function(e){formatWebviewInfo(e),log.info("webviewStores.js setUA "+webviewUA),this.emit("SET_WEBVIEW_UA",webviewUA),this.emit("SET_WEBVIEW_OFFSET",{width:webviewWidth,height:webviewHeight,dpr:webviewDpr})},getOffset:function(){return{height:webviewHeight,width:webviewWidth,dpr:webviewDpr}},getCurrentWebviewID:function(){return currentWebviewID},showShare:function(e,i){this.emit("SHOW_SHARE_WEBVIEW_"+e,e,i)},upStatus:function(e,i){webviewList[e]||(webviewList[e]={}),this.emit("UP_WEBVIEW_STATUS_"+e,e,i),this.emit("UP_WEBVIEW_STATUS",e,i)},setAction:function(e,i){webviewList[e]||(webviewList[e]={}),log.info("webviewStores.js setAction "+e+" "+JSON.stringify(i)),this.emit("SET_WEBVIEW_ACTION_"+e,e,i)},openDevtools:function(e,i){webviewList[e]||(webviewList[e]={}),log.info("webviewStores.js openDevtools "+e),this.emit("OPEN_WEBVIEW_DEVTOOLS",e,i)},execJSSDK:function(e,i){var t=this;webviewList[e]||(webviewList[e]={}),log.info("webviewStores.js execJSSDK begin: "+e+" "+JSON.stringify(i)),sdk.exec(i,webviewList[e],function(o,r,n){var s=i.sdkName,w=n.type;if(log.info("webviewStores.js execJSSDK end: "+e+" "+s+" "+w+" "+o+" "+JSON.stringify(r)+" "+JSON.stringify(n)),"CARD_SDK"===w&&o){var S=n.error;if(S){if(S.errcode===errcodeConfig.NOT_LIMITS_CARD)return log.info("webviewStores.js getA8key NOT_LIMITS_CARD"),void t.emit("NOT_LIMITS_CARD");if(0!==S.errcode){log.info("webviewStores.js getA8key "+S.errcode);var v=require("../common/jssdk/sdkNameTrans.js");return r={errMsg:v.getSdkDisplayName(s)+":fail"},t.emit("GET_JSSDK_RES_"+e,e,s,r,i.ext),void t.emit("GET_JASSDK_LOG",e,i,o,r,n)}}else t.emit("CRAD_SDK_RES",e,s,r,o,i)}else"PREVERIFY_SDK"===w?(webviewList[e].purviewFromPreVerify=n.purviewFromPreVerify||{},t.emit("GET_JSSDK_RES_"+e,e,s,r,i.ext)):"SHARE_SDK"===w?t.emit("SHOW_SHARE_WEBVIEW_"+e,e,i,r):"REGISTER_SDK"===w||("INTERFACE_SDK"===w?(t.emit("SET_INTERFACE_RES_"+e,e,s,o,i),t.emit("GET_JSSDK_RES_"+e,e,s,r,i.ext)):"WEBVIEW_SDK"===w?(t.emit("WEBVIEW_SDK",e,i,s,r),t.emit("GET_JSSDK_RES_"+e,e,s,r,i.ext)):t.emit("GET_JSSDK_RES_"+e,e,s,r,i.ext)),t.emit("GET_JASSDK_LOG",e,i,o,r,n)})},sendJSSDKRes:function(e,i,t,o){this.emit("GET_JSSDK_RES_"+e,e,i,t,o)},setJSSDKLog:function(e,i,t,o,r){this.emit("GET_JASSDK_LOG",e,i,t,o,r)},getA8key:function(e,i){var t=this;webviewList[e]={};var o=i.isSync;log.info("webviewStores.js getA8key begin: "+e+" "+JSON.stringify(i)),_getA8key.get(i,function(r){log.info("webviewStores.js getA8key end: "+JSON.stringify(r));var n=r.baseresponse,s=parseInt(n.errcode);if(log.info("webviewStores webview %s getA8keyRes %s %s",e,JSON.stringify(r)),s===errcodeConfig.NOT_LOGIN)return log.info("webviewStores.js getA8key NOT_LOGIN"),void t.emit("NOT_LOGIN");if(s===errcodeConfig.NOT_LIMITS)return log.info("webviewStores.js getA8key NOT_LIMITS"),void t.emit("NOT_LIMITS");if(s===errcodeConfig.NOT_LIMITS_QY)return log.info("webviewStores.js getA8key NOT_LIMITS_QY"),void t.emit("NOT_LIMITS_QY");if(s===errcodeConfig.INVALID_LOGIN||s===errcodeConfig.INVALID_TOKEN)return log.info("webviewStores.js getA8key INVALID_LOGIN"),void t.emit("INVALID_LOGIN");if(0!==s){log.info("webviewStores.js getA8key "+s);require("../actions/windowActions.js");return void windowActions.showTipsMsg("系统错误， 错误码 "+s)}webviewList[e].purviewFormGetA8key=r.purviewFormGetA8key;var w=r.resp_url;(o||s===errcodeConfig.ILLEGAL_URL)&&t.emit("SET_WEBVIEW_ACTION_"+e,e,{act:"load",url:w,from:i.from});var S=/\#wechat_redirect$/.test(i.url);return S&&i.url.replace(/\#wechat_redirect$/,"")===w?(w=w.replace(/\#wechat_redirect/,""),log.info("webviewStores.js getA8key GETA_8KEY_NOT_SUPPORT "+w),void t.emit("GETA_8KEY_NOT_SUPPORT",e,w)):(t.emit("GETA_8KEY_DONE_"+e,e),void t.emit("GETA_8KEY_DONE",e))})},getWebviewByID:function(e){return webviewList[e]},clearData:function(e){this.emit("CLEAR_WEBVIEW_DATA",e)}}),_on=Stores.on,_onNums={};Stores.on=function(){var e=arguments,i=e[0];_onNums[i]||(_onNums[i]=0),_onNums[i]++,_onNums[i]>=10&&log.error("webviewStores.js on "+i+" - times: "+_onNums[i]),_on.apply(this,arguments)};var _removeListener=Stores.removeListener;Stores.removeListener=function(){var e=arguments,i=e[0];_onNums[i]&&_onNums[i]--,_onNums[i]>=10&&log.error("webviewStores.js on "+i+" - times: "+_onNums[i]),_removeListener.apply(this,arguments)},module.exports=Stores;