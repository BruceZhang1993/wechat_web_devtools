"use strict";function generateCacheJson(e,a){var r={disable:!!a,name:e,base:"/release/"+e,manifest:{page:{},resource:{}}};return log.info("makePack.js generateCacheJson: "+JSON.stringify(r)),r}function pack(e,a,r,t){a=a||"o0sTXs9YbO5ZmL1JqmS1kdE1eaTE";var n=0,s=1,i=2,o=3,f=4,c=5,u=6,h=[new Buffer(4),new Buffer(4),new Buffer(4),new Buffer(28),new Buffer(4),new Buffer(4),new Buffer(4)];h[n].write(PROTOCOL_NAME),h[s].writeInt32LE(PROTOCOL_VERSION);var p=parseInt(+new Date/1e3);h[i].writeInt32LE(p);new Buffer(28);h[o].write(a);var l="**",g=path.join(e),w=path.join(uploadPath,"data_"+p),O=0,m=[],d=[],v=generateCacheJson(r);glob(l,{cwd:g},function(a,r){if(a)log.info("makePack.js glob error: "+JSON.stringify(a)+" ");else{var n=0;r.forEach(function(a){if("cache.json"!==a){var r=path.join(g,a),t=fs.lstatSync(r),s=(t.isDirectory(),t.isFile());if(s){O++;var i=fs.readFileSync(r),o=i.length;n+=o,m.push({path:a.replace(e,""),len:o}),d.push(i);var f=crypto.createHash("md5");f.update(i);var c=f.digest("hex").substr(0,8);/\.html$/.test(a)?v.manifest.page[a]=c:v.manifest.resource[a]=c}}});var s=new Buffer(JSON.stringify(v)),i=s.length;m.push({path:"cache.json",len:i}),d.push(s),n+=i,O++,h[f].writeInt32LE(O);var o="";m.forEach(function(e){o+=e.path+" "+e.len+"\n"}),o=new Buffer(o),h[c].writeInt32LE(o.length),h[u].writeInt32LE(n),h.push(o),h=h.concat(d);var p=Buffer.concat(h);fs.writeFileSync(w,p),log.info("makePack.js Create "+w+" success!"),t(w)}})}var glob=require("glob"),fs=require("fs"),crypto=require("crypto"),path=require("path"),mkdir=require("mkdir-p"),log=require("../common/log/log.js"),userCachePath=nw.App.getDataPath();userCachePath=path.join(userCachePath,"..");var uploadPath=path.join(userCachePath,"upload/");mkdir.sync(uploadPath);var PROTOCOL_NAME="LINC",PROTOCOL_VERSION=1;module.exports={pack:pack};