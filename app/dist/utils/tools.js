"use strict";var URL=require("url"),os=require("os"),path=require("path"),fs=require("fs"),net=require("net"),log=require("../common/log/log.js"),async=require("async"),App=nw.App,config,proxyCache={},getProxyLock=!1,getProxyTasks=[],isInitNotifications=!1,HTTP_PROXY_PORT=9973;module.exports={parseURL:function(n){var o=/^http(s)?:\/\//;return o.test(n)?n:"http://"+n},getAvailablePort:function(n,o){function t(n){var o=HTTP_PROXY_PORT,r=net.createServer();r.listen(o,function(t){r.once("close",function(){HTTP_PROXY_PORT=o+1,n(null,o)}),r.close()}),r.on("error",function(r){log.info("tools.js getAvailablePort error "+o),HTTP_PROXY_PORT++,t(n)})}for(var r=[],i=0;o>i;i++)r.push(t);async.series(r,function(o,t){log.info("tools.js getAvailablePort success "+JSON.stringify(t)),n(t)})},getAppConfig:function(){var n=nw.App.getDataPath(),o=path.join(n,"..","config.json"),t=fs.existsSync(o);if(!t)return{};var r={};try{r=JSON.parse(fs.readFileSync(o))}catch(i){}return log.info("tools.js getAppConfig: "+JSON.stringify(r)),r},getArgsURL:function(n){var o=Array.isArray(n);o||(n=n.split(" "));var t=n.find(function(n){return 0===n.indexOf("href://")});if(t){var r=t.replace("href://","");return this.parseURL(r)}},getSysIpInfo:function(){var n=os.networkInterfaces(),o=[];return Object.keys(n).forEach(function(t){var r=0;n[t].forEach(function(n){"IPv4"===n.family&&n.internal===!1&&(r>=1||o.push(n.address))})}),log.info("index.js getSysIpInfo: "+JSON.stringify(o)),o},openInspectWin:function(n){nw.Window.open("about:blank",{show:!1,width:799,height:799},function(n){n.maximize(),n.window.location="chrome://inspect/#devices",n.show(),log.info("index.js openInspectWin")})},clearProxyCache:function(){proxyCache={}},getProxyForURL:function(n){var o=URL.parse(n);return n=o.protocol+"//"+o.hostname,proxyCache[n]?log.info("tools.js getProxyForURL "+n+" from proxyCache: "+proxyCache[n]):(proxyCache[n]=nw.App.getProxyForURL(n),log.info("tools.js getProxyForURL "+n+" from nw.App.getProxyForURL: "+proxyCache[n])),proxyCache[n]},getVersionNum:function(){function n(n){return n=parseInt(n,10),10>n?"0"+n.toString():n.toString()}var o="",t=nw.App.manifest.version.split(".");return t.forEach(function(t){o+=n(t)}),o=parseInt(o,10),log.info("tools.js getVersionNum: "+o),this.getVersionNum=function(){return o},o},hasNewVersion:function(n){var o=n.clientConfig.last_version,t=nw.App.manifest.version;if(t===o||!o)return{};t=t.split(".");for(var r=o.split("."),i=0,e=r.length;e>i;i++){if(parseInt(r[i])>parseInt(t[i])){var s=n.urlConfig.webdebugger_download+"?from=tools&cv="+this.getVersionNum();return s+="darwin"===process.platform?"&os=darwin":"x64"===process.arch?"&os=x64":"&os=x86",{last_version:o,downloadURL:s}}if(parseInt(r[i])<parseInt(t[i]))return{}}},notifications:function(n,o,t,r){var i=(+new Date).toString();return r=r||function(){},t=t||[],isInitNotifications||(isInitNotifications={},chrome.notifications.onButtonClicked.addListener(function(n,o){isInitNotifications[n]&&isInitNotifications[n](o)})),isInitNotifications[i]=r,chrome.notifications.create(i,{type:"basic",iconUrl:"app/images/icon.png",title:n,message:o,buttons:t}),i}};