"use strict";function getValue(r,e){var t=r.find(function(r){return r.indexOf(e)>-1});return t?(t=t.trim(),t.split(/\s/).pop()):void 0}function getWinSystemProxySetting(r){var e='REG QUERY "HKCU\\SOFTWARE\\MICROSOFT\\WINDOWS\\CURRENTVERSION\\INTERNET SETTINGS"';exec(e,{},function(e,t,o){if(e)log.error("setAppProxy.js getWinSystemProxySetting commandStr: "+JSON.stringify(e)),r(e);else try{var n=t.split(/\r?\n/),i={};i.AutoConfigURL=getValue(n,"AutoConfigURL"),i.ProxyEnable=!!parseInt(getValue(n,"ProxyEnable")),i.ProxyServer=getValue(n,"ProxyServer"),i.ProxyOverride=getValue(n,"ProxyOverride"),i.ProxyOverride&&(i.ProxyOverride=i.ProxyOverride.split(";")),log.info("setAppProxy.js getWinSystemProxySetting: "+JSON.stringify(i)),r(null,i)}catch(s){log.error("setAppProxy.js getWinSystemProxySetting stdout error "+t+" "+JSON.stringify(s)),r(s)}})}function getOsxSystemProxySetting(r){var e=path.join(__dirname,"getosxproxysetting.sh");exec("sh "+e,{},function(e,t,o){if(e)log.error("setAppProxy.js getOsxSystemProxySetting : "+JSON.stringify(e)),r(e);else{var n=t.split(/\r?\n/);try{var i={};i.httpPrxoyEnable="Enabled: Yes"===n[0];var s=n[1].replace("Server:","").trim(),a=n[2].replace("Port:","").trim();i.httpProxy=s?s+":"+a:"",i.httpsProxyEnable="Enabled: Yes"===n[4];var P=n[5].replace("Server:","").trim(),y=n[6].replace("Port:","").trim();i.httpsProxy=P?P+":"+y:"";var p="Enabled: Yes"===n[9];i.AutoConfigURL=p?n[8].replace("URL:","").trim():"",0===n[10].indexOf("There aren't any bypass domains")?i.ProxyOverride=[]:i.ProxyOverride=n[10].split(" "),log.info("setAppProxy.js getOsxSystemProxySetting: "+JSON.stringify(i)),r(null,i)}catch(u){log.error("setAppProxy.js getOsxSystemProxySetting set: "+JSON.stringify(u)),r(u)}}})}function initProxy(r,e){r.AutoConfigURL?request(r.AutoConfigURL,function(t,o,n){if(t)e(t);else try{var i=path.join(proxyCachePath,"temppac.pac");fs.writeFileSync(i,n+"\n module.exports=FindProxyForURL","utf8");var s=require(i),a=s.toString();log.info("setAppProxy.js initProxy FindProxyForURLFun: "+a);var P=makeProxyLocal(),y=makeProxyOverride(),p=n.replace(a,"\n            function FindProxyForURL(url, host) {\n              "+P+"\n              "+y+"\n              "+a+"\n              return FindProxyForURL(url, host)\n            }\n        "),u=path.join(proxyCachePath,"pacFile.pac");if(fs.writeFileSync(u,n.replace(a,p)),log.info("setAppProxy.js initProxy write "+u+" success"),isWin){var x=document.createElement("img");x.src=u,r.AutoConfigURL=x.src+"?"+ +new Date}else r.AutoConfigURL=encodeURI("file:///"+u+"?"+ +new Date);e(null,r)}catch(c){e(c)}}):e(null,r)}function makeProxyOverride(r){try{if(r&&r.length){var e=r.map(function(r){return"host.indexOf('"+r+"') === 0"});return e=e.join("||"),log.info("setAppProxy.js makeProxyOverride "+e),"if("+e+") {\n        return 'DIRECT'\n      }\n      "}return""}catch(t){return log.error("setAppProxy.js makeProxyOverride error: "+JSON.stringify(t)),""}}function makeProxyLocal(){var r=proxyRule.getRuleJson(),e=Object.keys(r);e.push(devtoolsBaseURL),e.push(debugOpenURL),e.push(nwReportURL);var t=e.map(function(r){return"url.indexOf('"+r+"') === 0"});return t=t.join("||"),log.info("setAppProxy.js makeProxyLocal "+t),"if ("+t+") {\n    return 'PROXY 127.0.0.1:"+global._port+"'\n  }\n  "}function makeProxyConfig(r,e){if(r===PROXY_PAC_TYPE)return{mode:"pac_script",pacScript:{url:e.AutoConfigURL}};if(r===PROXY_DIRECT_TYPE){var t=makeProxyLocal(),o=makeProxyOverride();return{mode:"pac_script",pacScript:{data:"function FindProxyForURL(url, host) {\n                "+t+"\n                "+o+"\n                return 'DIRECT'\n              }"}}}if(isWin&&r===PROXY_URL_TYPE){var t=makeProxyLocal(),o=makeProxyOverride(e.ProxyOverride),n="";if(e.ProxyServer)if(-1===e.ProxyServer.indexOf("="))n="return 'PROXY "+e.ProxyServer+"'";else{var i=e.ProxyServer.split(";");i.forEach(function(r){var e=r.replace(/https?=/,"");0===r.indexOf("https")?n+="\n            if(url.indexOf('https') === 0)\n              return 'PROXY "+e+"'\n          ":0===r.indexOf("http")&&(n+="\n            if(url.indexOf('http') === 0 && url.indexOf('https') === -1)\n              return 'PROXY "+e+"'\n          ")})}else n="return 'DIRECT'";return{mode:"pac_script",pacScript:{data:"function FindProxyForURL(url, host) {\n                "+t+"\n                "+o+"\n                "+n+"\n                return 'DIRECT'\n              }"}}}if(!isWin&&r===PROXY_URL_TYPE){var t=makeProxyLocal(),o=makeProxyOverride(e.ProxyOverride),s="";return e.httpsProxyEnable&&(s+="\n        if(url.indexOf('https:') === 0)\n          return 'PROXY "+e.httpsProxy+"'\n      "),e.httpPrxoyEnable&&(s+="\n        if(url.indexOf('http:') === 0)\n          return 'PROXY "+e.httpProxy+"'\n      "),e.ProxyServer&&(s="return 'PROXY "+e.ProxyServer+"'"),{mode:"pac_script",pacScript:{data:"function FindProxyForURL(url, host) {\n                "+t+"\n                "+o+"\n                "+s+"\n                return 'DIRECT'\n              }"}}}}function setChromeProxy(r,e){chrome.proxy.settings.set({value:r,scope:"regular"},function(){e()}),isReady||(isReady=!0,watch())}function watch(){fs.watchFile(cacheRulePath,function(){set(function(){log.info("setAppProxy.js watch cacheRule accessed")})})}function setProxy(r,e){var t=void 0;t=r.AutoConfigURL?makeProxyConfig(PROXY_PAC_TYPE,r):isWin&&r.ProxyEnable?makeProxyConfig(PROXY_URL_TYPE,r):isWin||!r.httpPrxoyEnable&&!r.httpsProxyEnable?makeProxyConfig(PROXY_DIRECT_TYPE):makeProxyConfig(PROXY_URL_TYPE,r),log.info("setAppProxy.js setProxy config: "+JSON.stringify(t)),setChromeProxy(t,function(){e(null,r)})}function set(r){var e=windowStores.getProxySetting();if(tools.clearProxyCache(),"SYSTEM"===e){var t=[];isWin?t.push(getWinSystemProxySetting):t.push(getOsxSystemProxySetting),t.push(initProxy),t.push(setProxy),async.waterfall(t,function(e,t){if(e){var o=makeProxyConfig(PROXY_DIRECT_TYPE);setChromeProxy(o,function(){r()}),log.error("setAppProxy.js set system error "+JSON.stringify(e))}else r()})}else if("DIRECT"===e){var o=makeProxyConfig(PROXY_DIRECT_TYPE);setChromeProxy(o,function(){r()})}else{var o=makeProxyConfig(PROXY_URL_TYPE,{ProxyServer:e.replace("PROXY ","")});setChromeProxy(o,function(){r()})}}function up(r){set(r)}var exec=require("child_process").exec,request=require("request"),async=require("async"),path=require("path"),fs=require("fs"),App=nw.App,log=require("../log/log.js"),mkdir=require("mkdir-p"),windowActions=require("../../actions/windowActions.js"),windowStores=require("../../stroes/windowStores.js"),proxyRule=require("./proxyRule.js"),tools=require("../../utils/tools.js"),isWin="win32"===process.platform,cacheRulePath=proxyRule.getCacheRulePath(),isReady=!1,PROXY_PAC_TYPE=0,PROXY_DIRECT_TYPE=1,PROXY_URL_TYPE=2,userCachePath=path.join(nw.App.getDataPath(),".."),proxyCachePath=path.join(userCachePath,"proxyCache/");mkdir.sync(proxyCachePath);var devtoolsBaseURL="https://chrome-devtools-frontend.appspot.com/serve_rev/@180870/",debugOpenURL="http://debug.open.weixin.qq.com/",nwReportURL="https://clients1.google.com/tbproxy/af/";module.exports={set:set,up:up};