"use strict";function upDateRuleFile(){fs.writeFileSync(cacheRulePath,JSON.stringify(ruleJson))}function trasnlateReqToUrlParse(e){var r=e.headers.host,t=e.connection.encrypted&&!/^http:/.test(e.url)?"https":"http",a="http"===t?e.url:t+"://"+r+e.url,n=url.parse(a);return n.pureHref=n.href.replace(/\?.*/,"").replace(/\#.*/,""),n}var fs=require("fs"),HttpsProxyAgent=require("./HttpsProxyAgent.js"),AddWeinreJS=require("./addWeinreJS.js"),url=require("url"),rmdir=require("rmdir"),path=require("path"),mkdir=require("mkdir-p"),zlib=require("zlib"),tools=require("../../utils/tools.js"),projectStores=global.appConfig.project?require("../../stroes/projectStores.js"):void 0,report=require("../../utils/report.js"),DEVTOOLS_TYPE=7,devtoolsBaseURL="https://chrome-devtools-frontend.appspot.com/serve_rev/@180870/",debugServerBaseURL="http://debug.open.weixin.qq.com/",nwReportURL="https://clients1.google.com/tbproxy/af/",userCachePath=nw.App.getDataPath();userCachePath=path.join(userCachePath,"..");var cacheDirPath=path.join(userCachePath,"wechatCache/");mkdir.sync(cacheDirPath);var cacheRulePath=path.join(userCachePath,"ruleJson.js"),isExist=fs.existsSync(cacheRulePath),ruleJson;isExist?ruleJson=JSON.parse(fs.readFileSync(cacheRulePath)):(ruleJson={},fs.writeFileSync(cacheRulePath,"{}")),module.exports={isMatchLocalFile:function(e){return e=e.replace(/\?.*/,"").replace(/\#.*/,""),!!ruleJson[e]},getCacheDirPath:function(){return cacheDirPath},getCacheRulePath:function(){return cacheRulePath},clearCacheRule:function(e){rmdir(cacheDirPath,function(r,t,a){ruleJson={},upDateRuleFile(),mkdir.sync(cacheDirPath),e&&e()})},getRuleJson:function(){return ruleJson},setRuleJson:function(e){for(var r in e)ruleJson[r]=e[r];upDateRuleFile()},replaceRequestOption:function(e,r,t){var a=e.headers.host,n=e.connection.encrypted&&!/^http:/.test(e.url)?"https":"http",s="http"===n?e.url:n+"://"+a+e.url,o=url.parse(s),i=tools.getProxyForURL(o.href);if("DIRECT"!==i){i=i.replace("PROXY ","").split(":");var l=i[0],c=parseInt(i[1]),u=/https/.test(n);u?r.agent=new HttpsProxyAgent({proxyHost:l,proxyPort:c}):(r.path=o.href,r.port=c,r.host=l,delete r.hostname)}t()},shouldUseLocalResponse:function(e,r){var t=trasnlateReqToUrlParse(e),a=t.pureHref;return 0===a.indexOf(devtoolsBaseURL)?!0:0===a.indexOf(debugServerBaseURL)?global.appConfig.project:0===a.indexOf(nwReportURL)?!0:!!ruleJson[a]},dealLocalResponse:function(e,r,t){var a=trasnlateReqToUrlParse(e),n=a.pureHref;if(0===n.indexOf(devtoolsBaseURL)){var s=n.replace(devtoolsBaseURL,"")||"devtools.html";"180870.manifest"===s&&report([{type:DEVTOOLS_TYPE,times:1}]);var o=path.join(__dirname,"manifest",s),i=fs.readFileSync(o);t(200,{},i)}else if(0===n.indexOf(debugServerBaseURL)){var l=projectStores.getProjectList(),c=n.match(/http:\/\/debug\.open\.weixin\.qq\.com\/(.*?)\/.*/),u=c?c[1]:"";c=n.match(/http:\/\/debug\.open\.weixin\.qq\.com\/.*?\/(.*?)\/.*/);var h=c?c[1]:"";u&&h?!function(){var e=u+"_"+h,r=l.find(function(r){return r.projectid===e});if(r){var a=n.replace(debugServerBaseURL,"").replace(u+"/"+h+"/","")||"index.html",s=path.join(r.projectpath,a);try{var o=fs.readFileSync(s);t(200,{},o)}catch(i){t(404,{},"")}}}():t(403,{},"")}else if(0===n.indexOf(nwReportURL))t(400,{},"");else{var p=JSON.parse(fs.readFileSync(ruleJson[n].filePath+".response")),d=fs.readFileSync(ruleJson[n].filePath);p.resHeader["from-wechat-cache"]=ruleJson[n].version,t(p.statusCode,p.resHeader,d)}},replaceServerResDataAsync:function(e,r,t,a){var n,s=r.headers["content-encoding"]||"",o=s.indexOf("gzip")>=0;if(n=ruleJson[e.url]?fs.readFileSync(ruleJson[e.url]):AddWeinreJS(e.headers,r.headers,t),o){var i=zlib.gzipSync(n);r.headers["content-length"]=i.length,a(i)}else r.headers["content-length"]=n.length,a(n)},replaceResponseHeader:function(e,r,t){var a=trasnlateReqToUrlParse(e),n=a.pureHref;ruleJson[n]&&(t["from-wechat-cache"]=ruleJson[n].version)}};