"use strict";function refreshTicket(e,r,t){var n=(windowStores.getUserInfo(),{url:refreshTicketURL,form:JSON.stringify({openid:e,signature:r}),method:"post",needToken:!1});sendRequest(n,function(e,r,n){if(e)log.error("request.js refreshTicket error "+JSON.stringify(e)),t(e);else{log.info("request.js refreshTicket "+n),n=JSON.parse(n);var i=n.baseresponse,s=parseInt(i.errcode);if(0!==s)return log.error("request.js refreshTicket errcode: "+s),void t({type:"NOT_LOGIN"});var o=+new Date+1e3*n.ticket_expired_time,u=r.headers,c=u["debugger-newticket"];windowActions.upTicket(c,o),t(null,c)}})}function makeRequestOpt(e,r){function t(r){var t=tools.getProxyForURL(e.url);"DIRECT"!==t&&(e.proxy="http://"+t.replace("PROXY ",""),e.tunnel=tunnel),r(null)}function n(r){var t=e.needToken;if(!t)return void r(null);var n=windowStores.getUserInfo();if(!n)return log.info("request.js setToken get userInfo null"),void r({type:"NOT_LOGIN"});var i=n.ticketExpiredTime,s=n.signatureExpiredTime,o=+new Date;return o>s?(log.info("request.js setToken signature expired "+s+" "+o),void r({type:"NOT_LOGIN"})):void(o>i?(log.info("request.js setToken ticket expired "+i+" "+o),refreshTicket(n.openid,n.signature,function(t,n){t?r(t):(e.newticket=n,r(null))})):(e.newticket=n.newticket,r(null)))}async.parallel([t,n],function(t){if(t)r(t);else{var n=e.needToken;n&&(e.url=e.url+"?newticket="+e.newticket+"&ticket="+e.ticket),delete e.newticket,delete e.needToken,r(null,e)}})}function sendRequest(e,r){var t=Object.assign({},e);log.info("request.js begin makeRequestOpt "+JSON.stringify(e)),makeRequestOpt(e,function(e,n){e?(log.error("request.js makeRequestOpt opt: "+JSON.stringify(t)+"  error: "+JSON.stringify(e)),t.url===urlConfig.CLIENTREPORT_URL&&(t.needToken=!1,sendRequest(t,callback)),setTimeout(function(){windowActions.clearUserInfo("请重新登录")})):(log.info("request.js end makeRequestOpt "+JSON.stringify(n)),request(n,function(e,i,s){if(e){if(log.error("request.js request error "+JSON.stringify(e)),"UNABLE_TO_VERIFY_LEAF_SIGNATURE"===e.code&&(tunnel=!confirm("当前系统代理不是安全代理，是否信任？"),!tunnel))return n.tunnel=!1,void request(n,function(e,t,n){r(e,t,n)})}else if(t.needToken){var o=JSON.parse(s),u=o.baseresponse||{},c=parseInt(u.errcode);if(c===API_Expired_Access_token)return log.info("request.js sendRequest get errcode === API_Expired_Access_token"),windowActions.delTicket(),void sendRequest(t,r)}r(e,i,s)}))})}var request=require("request"),tools=require("../../utils/tools.js"),log=require("../log/log.js"),windowStores=require("../../stroes/windowStores.js"),windowActions=require("../../actions/windowActions.js"),async=require("async"),urlConfig=require("../../config/urlConfig.js"),refreshTicketURL=urlConfig.refreshTicketURL,tunnel=!0,API_Expired_Access_token=42001,API_Expired_Refresh_token=42002;module.exports=sendRequest;