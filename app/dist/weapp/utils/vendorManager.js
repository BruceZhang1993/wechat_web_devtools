"use strict";function init(){var e=global.appConfig.isDev,n=require("path"),r=require("fs"),i=require("events").EventEmitter,o=require("request"),t=require("../../actions/windowActions.js"),c=require("../../stores/projectStores.js"),a=require("../../config/dirConfig.js"),s="darwin"===process.platform,f=a.WeappVendor,u=n.join(f,"config.json"),d=require("../../common/log/log.js"),l=n.join(__dirname,"../onlinevendor/"),v=n.join(l,"config.json"),g=JSON.parse(r.readFileSync(v,"utf8")),y=n.join(__dirname,"../vendor/"),j=(n.join(l,"vendorConfig.json"),s?{wcc:!0,wcsc:!0}:{"wcc.exe":!0,"wcsc.exe":!0});j["hls.js"]=!1,j["WAWidget.js"]=!1,j.region=!1;var S=void 0,m={},h={},p=function(e){t.showTipsMsg({type:"error",msg:e})},V=function(e){d.error(__filename+" "+e)},C=new i,w=function(){try{if(S=JSON.parse(r.readFileSync(u,"utf8")),S.configVersion>=g.configVersion)return void _()}catch(e){d.error(__filename+" checkVendorConfig catch error "+e)}F(),_()},F=function(){var e=JSON.stringify(g);r.writeFileSync(u,e),S=g;for(var i in j){var o=n.join(f,i),t=r.readFileSync(n.join(l,i));j[i]?r.writeFileSync(o,t,{mode:511}):r.writeFileSync(o,t)}var a=S.currentLibVersion,s=n.join(l,a);if(r.existsSync(s)){var d=r.readdirSync(s),v=n.join(f,a);r.existsSync(v)||r.mkdirSync(v),d.forEach(function(e){r.writeFileSync(n.join(v,e),r.readFileSync(n.join(s,e)))})}c.resetProjectLibVersion(S.currentLibVersion),C.emit("VENDOR_CONFIG_CHANGE",S)},_=function(){for(var e in j){var i=n.join(f,e);m[e]=r.readFileSync(i)}},N=function(i,o){var t="";if(e)t=r.readFileSync(n.join(y,i),"utf8");else if(j.hasOwnProperty(i))t=m[i];else if(m[o]&&m[o][i])t=m[o][i];else try{O(o),t=m[o][i]}catch(e){}return t},O=function(e){if(m[e]={},S.libs[e]){var i=S.libs[e],o=n.join(f,e);try{for(var t in i){var c=n.join(o,t);m[e][t]=r.readFileSync(c,"utf8")}return}catch(e){V("initVendorCache readFile from vendorPath catch error "+e)}o=n.join(l,e);try{var a=n.join(f,e);r.existsSync(a)||r.mkdirSync(a);for(var s in i){var u=r.readFileSync(n.join(o,s),"utf8");r.writeFileSync(n.join(a,s),u),m[e][s]=u}return}catch(e){V("initVendorCache readFile from toolsVendorPath catch error "+e)}for(var d in i)q({url:i[d]||"https://dldir1.qq.com/WechatWebDev/vendor/"+e+"/"+d,fileName:d,version:e});p("正在下载对应版本的基础库，请稍后重新编译")}else F(),p("基础库版本异常，正在重建，请稍后重新编译")},q=function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};h[e.url]&&clearTimeout(h[e.url]);var t=e.fileName,c=e.version;h[e.url]=setTimeout(function(){o({url:e.url,needToken:!1,encoding:null},function(e,o,a){if(e)i("未找到 "+t+" "+e,{fileName:t,version:c});else{var s=a.toString();m[c]||(m[c]={}),m[c][t]=s;var u=n.join(f,c);r.existsSync(u)||r.mkdirSync(u),r.writeFileSync(n.join(u,t),s),i(null,{fileName:t,version:c,fileData:s})}})})},b=function(e){if(m[e]){var n=S.libs[e];if(n){for(var r in n)if(!m[e][r])return!1;return!0}}return!1},x=function(e,n){try{b(e)||O(e),C.emit("VENDOR_CHANGE"),n(null)}catch(e){}},E=function(e){if(e){var n={url:e,needToken:0,encoding:null};d.info(__filename+" begin get new vendorConfig "+e),o(n,function(e,n,i){if(e)V("vendorManager.js updateVendorConfig end error "+e);else try{var o=JSON.parse(i.toString());S.configVersion<o.configVersion?(S=o,r.writeFileSync(u,JSON.stringify(S)),C.emit("VENDOR_CONFIG_CHANGE",S),t.showTipsMsg({msg:"更新基础库配置成功！",type:"success"}),d.info(__filename+" updateVendorConfig end get new vendorConfig: "+S)):V("updateVendorConfig end get old vendorConfig")}catch(e){V("updateVendorConfig end catch "+e.toString())}})}},k=function(){return S.currentLibVersion},D=function(){return S};w(),_exports={on:function(e,n){C.on(e,n)},removeListener:function(e,n){C.removeListener(e,n)},checkConfig:function(e){try{var n=e.vendor;n&&(n=JSON.parse(n),n.version&&n.version>S.configVersion&&E(n.url))}catch(e){d.error("vendorManager checkConfig catch error "+e)}},getFile:N,changeVendorVersion:x,updateVendorConfig:E,getVendorConfig:D,getCurrentVendorVersion:k}}var _exports;init(),module.exports=_exports;