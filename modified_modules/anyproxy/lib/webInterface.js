"use strict";function webInterface(e){var t=e.port,r=e.wsPort,n=e.ip,o=e.userRule,i="",a=[];try{i=o.summary(),a=o._getCustomMenu()}catch(s){}var c=this,u="http://"+n+":"+t+"/",l=certMgr.getRootCAFilePath(),d=path.join(__dirname,"../web"),p=express();p.use(compress()),p.use(function(e,t,r){return t.setHeader("note","THIS IS A REQUEST FROM ANYPROXY WEB INTERFACE"),r()}),p.get("/lastestLog",function(e,t){recorder.getRecords(null,120,function(e,r){e?t.end(e.toString()):t.json(r)})}),p.get("/fetchCrtFile",function(e,t){l?(t.setHeader("Content-Type","application/x-x509-ca-cert"),t.setHeader("Content-Disposition",'attachment; filename="rootCA.crt"'),t.end(fs.readFileSync(l,{encoding:null}))):(t.setHeader("Content-Type","text/html"),t.end("can not file rootCA ,plase use <strong>anyproxy --root</strong> to generate one"))}),p.get("/qr",function(e,t){var r,n,o=qrCode.qrcode(4,"M"),i=u;o.addData(i),o.make(),r=o.createImgTag(4),n='<a href="__url"> __img <br> click or scan qr code to start client </a>'.replace(/__url/,i).replace(/__img/,r),t.setHeader("Content-Type","text/html"),t.end(n)}),p.get("/qr_root",function(e,t){var r,n,o=qrCode.qrcode(4,"M"),i=u+"fetchCrtFile";o.addData(i),o.make(),r=o.createImgTag(4),n='<a href="__url"> __img <br> click or scan qr code to download rootCA.crt </a>'.replace(/__url/,i).replace(/__img/,r),t.setHeader("Content-Type","text/html"),t.end(n)}),p.use(function(e,t,o){var s=fs.readFileSync(path.join(d,"/index.html"),{encoding:"utf8"}),c={rule:i||"",customMenu:a||[],wsPort:r,ipAddress:n||"127.0.0.1"};"/"==url.parse(e.url).pathname?(t.setHeader("Content-Type","text/html"),t.end(juicer(s,c))):o()}),p.use(express["static"](d)),"function"==typeof o._plugIntoWebinterface?o._plugIntoWebinterface(p,function(){p.listen(t)}):p.listen(t),c.app=p}var express=require("express"),url=require("url"),fs=require("fs"),path=require("path"),events=require("events"),inherits=require("util").inherits,qrCode=require("qrcode-npm"),util=require("./util"),certMgr=require("./certMgr"),logUtil=require("./log"),juicer=require("juicer"),compress=require("compression");inherits(webInterface,events.EventEmitter),module.exports=webInterface;