"use strict";function resToMsg(e,o){var t,r={};try{t=JSON.parse(e)}catch(n){return r={type:"error",error:"failed to parse your request : "+n.toString()},void(o&&o(r))}return t.reqRef&&(r.reqRef=t.reqRef),"reqBody"==t.type&&t.id?(r.type="body",void GLOBAL.recorder.getBodyUTF8(t.id,function(e,n){e?r.content={id:null,body:null,error:e.toString()}:r.content={id:t.id,body:n},o&&o(r)})):null}function wsServer(e){var o=this,t=new WebSocketServer({port:e.port});t.broadcast=function(e){e.id;"object"==("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e));for(var o in this.clients)try{this.clients[o].send(e)}catch(t){logUtil.printLog("websocket failed to send data, "+t,logUtil.T_ERR)}},t.on("connection",function(e){e.on("message",function(o){resToMsg(o,function(o){o&&e.send(JSON.stringify(o))})})}),t.on("close",function(){}),GLOBAL.recorder.on("update",function(e){try{t&&t.broadcast({type:"update",content:e})}catch(o){console.log("ws error"),console.log(o)}}),o.wss=t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},WebSocketServer=require("ws").Server,logUtil=require("./log");wsServer.prototype.closeAll=function(){var e=this;e.wss.close()},module.exports=wsServer;