"use strict";function saveMapConfig(e,o){new Promise(function(o,n){var t=utils.getAnyProxyHome(),r=path.join(t,configFile);"object"==("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e)),o({path:r,content:e})}).then(function(e){return new Promise(function(o,n){fs.writeFile(e.path,e.content,function(e){e?n(e):o()})})})["catch"](function(e){o&&o(e)}).done(function(){o&&o()})}function getMapConfig(e){var o=Promise.denodeify(fs.readFile);new Promise(function(e,o){var n=utils.getAnyProxyHome(),t=path.join(n,configFile);e(t)}).then(o).then(function(e){return JSON.parse(e)})["catch"](function(o){e&&e(o)}).done(function(o){e&&e(null,o)})}function mergeCORSHeader(e,o){var n=o||{};return delete n["Access-Control-Allow-Credentials"],delete n["Access-Control-Allow-Origin"],delete n["Access-Control-Allow-Methods"],delete n["Access-Control-Allow-Headers"],n["access-control-allow-credentials"]="true",n["access-control-allow-origin"]=e.origin||e.Origin||"-___-||",n["access-control-allow-methods"]="GET, POST, PUT",n["access-control-allow-headers"]=e["access-control-request-headers"]||"-___-||",n}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},utils=require("./util"),bodyParser=require("body-parser"),path=require("path"),fs=require("fs"),Promise=require("promise"),isRootCAFileExists=require("./certMgr.js").isRootCAFileExists(),interceptFlag=!1,mapConfig=[],configFile="mapConfig.json";setTimeout(function(){getMapConfig(function(e,o){o&&(mapConfig=o)})},1e3),module.exports={summary:function(){var e="the default rule for AnyProxy which supports CORS.";return isRootCAFileExists||(e+="\nRoot CA does not exist, will not intercept any https requests."),e},shouldUseLocalResponse:function(e,o){if("OPTIONS"==e.method)return!0;var n=(e.headers.host||"")+(e.url||"");return mapConfig.map(function(o){var t=o.keyword;return n.indexOf(t)>=0?(e.anyproxy_map_local=o.local,!1):void 0}),!!e.anyproxy_map_local},dealLocalResponse:function(e,o,n){"OPTIONS"==e.method?n(200,mergeCORSHeader(e.headers),""):e.anyproxy_map_local&&fs.readFile(e.anyproxy_map_local,function(e,o){e?n(200,{},"[AnyProxy failed to load local file] "+e):n(200,{},o)})},replaceRequestProtocol:function(e,o){},replaceRequestOption:function(e,o){},replaceRequestData:function(e,o){},replaceResponseStatusCode:function(e,o,n){},replaceResponseHeader:function(e,o,n){return mergeCORSHeader(e.headers,n)},replaceServerResDataAsync:function(e,o,n,t){t(n)},pauseBeforeSendingResponse:function(e,o){},saveAllHttpResponse:function(e,o,n,t){},shouldInterceptHttpsReq:function(e){return interceptFlag},fetchTrafficData:function(e,o){},setInterceptFlag:function(e){interceptFlag=e&&isRootCAFileExists},_plugIntoWebinterface:function(e,o){e.get("/filetree",function(e,o){try{var n=e.query.root||utils.getUserHome()||"/";utils.filewalker(n,function(e,n){o.json(n)})}catch(t){o.end(t)}}),e.use(bodyParser.json()),e.get("/getMapConfig",function(e,o){o.json(mapConfig)}),e.post("/setMapConfig",function(e,o){mapConfig=e.body,o.json(mapConfig),saveMapConfig(mapConfig)}),o()},_getCustomMenu:function(){return[]}};