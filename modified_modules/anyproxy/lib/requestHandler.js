"use strict";function userRequestHandler(e,r){function t(r){var t=[];e.on("data",function(e){t.push(e)}),e.on("end",function(){l=Buffer.concat(t),s.reqBody=l.toString(),GLOBAL.recorder&&GLOBAL.recorder.updateRecord(h,s),r()})}function n(r){userRule.shouldUseLocalResponse(e,l)?(logUtil.printLog("==>use local rules"),o(r)):(logUtil.printLog("==>will forward to real server by proxy"),u(r))}function o(t){userRule.dealLocalResponse(e,l,function(e,n,o){s.endTime=(new Date).getTime(),s.res={statusCode:e||"",headers:n||{}},s.resHeader=n||{},s.resBody=o,s.length=o?o.length:0,s.statusCode=e,r.writeHead(e,n),r.end(o),t&&t()})}function u(t){var n;a=userRule.replaceRequestProtocol(e,a)||a,n={hostname:p.hostname||e.headers.host,port:p.port||e.port||(/https/.test(a)?443:80),path:d,method:e.method,headers:e.headers},userRule.replaceRequestOption(e,n,function(){n.rejectUnauthorized=!1,l=userRule.replaceRequestData(e,l)||l,n.headers=util.lower_keys(n.headers),n.headers["proxy-connection"]&&(n.headers.connection=n.headers["proxy-connection"],delete n.headers["proxy-connection"]),n.headers["accept-language"]&&(n.headers["accept-language"]="zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"),n.headers["content-length"]=l.length;var o=(/https/.test(a)?https:http).request(n,function(n){var o=n.statusCode;o=userRule.replaceResponseStatusCode(e,n,o)||o;var u=userRule.replaceResponseHeader(e,n,n.headers)||n.headers;u=util.lower_keys(u);var l=/gzip/i.test(u["content-encoding"]),i=[];n.on("data",function(e){i.push(e)}),n.on("end",function(){var a;async.series([function(e){a=Buffer.concat(i),l?zlib.gunzip(a,function(r,t){a=t,e()}):e()},function(r){userRule.replaceServerResData?(logUtil.printLog(color.red("replaceServerResData is deprecated, and will be unavilable soon. Use replaceServerResDataAsync instead."),logUtil.T_ERR),a=userRule.replaceServerResData(e,n,a)||a,r()):userRule.replaceServerResDataAsync?userRule.replaceServerResDataAsync(e,n,a,function(e){a=e,r()}):r()},function(r){var t=userRule.pauseBeforeSendingResponse(e,n);t?setTimeout(r,t):r()},function(t){if(userRule.saveAllHttpResponse(e,o,u,a),r.writeHead(o,u),GLOBAL._throttle){var n=new Stream,s=n.pipe(GLOBAL._throttle.throttle());s.pipe(r),n.emit("data",a),n.emit("end"),t()}else r.end(a),t()},function(e){s.endTime=(new Date).getTime(),s.statusCode=o,s.resHeader=u,s.resBody=l?zlib.gunzipSync(a):a,s.length=a?a.length:0,GLOBAL.recorder&&GLOBAL.recorder.updateRecord(h,s),e()},function(e){userRule.fetchTrafficData&&userRule.fetchTrafficData(h,s),e()}],function(e,r){t&&t()})}),n.on("error",function(e){logUtil.printLog("error"+e,logUtil.T_ERR)})});o.on("error",function(t){logUtil.printLog("err with request :"+t+"  "+e.url,logUtil.T_ERR),r.end()}),o.end(l)})}var s,l,i=e.headers.host,a=e.connection.encrypted&&!/^http:/.test(e.url)?"https":"http",c="http"===a?e.url:a+"://"+i+e.url,p=url.parse(c),d=p.path,h=-1;s={host:i,method:e.method,path:d,protocol:a,url:a+"://"+i+d,req:e,startTime:(new Date).getTime()};var f=(e.headers["user-agent"]||"",!1);!f&&GLOBAL.recorder&&(h=GLOBAL.recorder.appendRecord(s)),logUtil.printLog(color.green("\nreceived request to : "+i+d)),async.series([t,n],function(){e.anyproxy_map_local&&GLOBAL.recorder.updateExtInfo(h,{map:e.anyproxy_map_local})})}function connectReqHandler(e,r,t){var n,o,u=e.url.split(":")[0],s=parseInt(e.url.split(":")[1]),l=userRule.shouldInterceptHttpsReq(e);s==GLOBAL.option.socketPort&&(l=!1),logUtil.printLog(color.green("\nreceived https CONNECT request "+u)),l?logUtil.printLog("==>will forward to local https server"):logUtil.printLog("==>will bypass the man-in-the-middle proxy"),n={host:u,method:e.method,path:"",url:"https://"+u,req:e,startTime:(new Date).getTime()},o=GLOBAL.recorder.appendRecord(n);var i,a,c,p;async.series([function(e){return l?void(c?e():getPort(function(r){if(c=r,443===s)p=new httpsServerMgr({port:r,handler:userRequestHandler});else{var t=http.createServer(userRequestHandler);t.listen(c),t.on("upgrade",function(e,r,t){if(WebSocket.isWebSocket(e)){var n=new WebSocket(e,r,t);n.on("message",function(e){n.send(e.data)}),n.on("close",function(e){n=null})}})}e()})):void e()},function(e){l?(i=c,a="127.0.0.1",e()):(i=s,a=u,e())},function(t){try{var n=net.connect(i,a,function(){r.write("HTTP/"+e.httpVersion+" 200 OK\r\n\r\n","UTF-8",function(){if(GLOBAL._throttle&&!l){var e=n.pipe(GLOBAL._throttle.throttle());e.pipe(r),r.pipe(n)}else n.pipe(r),r.pipe(n);t()})});n.on("error",function(e){logUtil.printLog("err when connect to + "+u+" , "+e,logUtil.T_ERR)})}catch(o){logUtil.printLog("err when connect to remote https server (__host)".replace(/__host/,u),logUtil.T_ERR)}},function(e){n.endTime=(new Date).getTime(),n.statusCode="200",n.resHeader={},n.resBody="",n.length=0,GLOBAL.recorder&&GLOBAL.recorder.updateRecord(o,n),e()}],function(e,r){if(e)throw logUtil.printLog("err "+e,logUtil.T_ERR),e})}function setRules(e){if(e){e.summary||(e.summary=function(){return"this rule file does not have a summary"}),userRule=util.merge(defaultRule,e);var r=[];"function"==typeof userRule.init&&r.push(function(e){userRule.init(e)}),"function"==typeof userRule.summary&&r.push(function(e){logUtil.printLog(userRule.summary()),e(null)}),async.series(r,function(e,r){e||logUtil.printLog(color.green("Anyproxy rules initialize finished, have fun!"))})}}function getRuleSummary(){return userRule.summary()}var http=require("http"),https=require("https"),net=require("net"),fs=require("fs"),url=require("url"),pathUtil=require("path"),zlib=require("zlib"),async=require("async"),color=require("colorful"),Buffer=require("buffer").Buffer,util=require("./util"),getPort=require("./getPort"),Stream=require("stream"),logUtil=require("./log"),httpsServerMgr=require("./httpsServerMgr"),WebSocket=require("faye-websocket"),defaultRule=require("./rule_default.js"),userRule=defaultRule;module.exports.userRequestHandler=userRequestHandler,module.exports.connectReqHandler=connectReqHandler,module.exports.setRules=setRules,module.exports.getRuleSummary=getRuleSummary;