"use strict";function Recorder(e){var t,r=this,i=1;if(e=e||{},e.filename&&"string"==typeof e.filename)try{fs.existsSync(e.filename)&&fs.writeFileSync(e.filename,""),t=new Datastore({filename:e.filename,autoload:!0}),t.persistence.setAutocompactionInterval(5001),logUtil.printLog("db file : "+e.filename)}catch(n){logUtil.printLog(n,logUtil.T_ERR),logUtil.printLog("Failed to load on-disk db file. Will use in-meomory db instead.",logUtil.T_ERR),t=new Datastore}else t=new Datastore;r.recordBodyMap=[],r.emitUpdate=function(e,t){t?r.emit("update",t):r.getSingleRecord(e,function(e,t){!e&&t&&t[0]&&r.emit("update",t[0])})},r.updateRecord=function(e,i){if(!(0>e)){var n=normalizeInfo(e,i);t.update({_id:e},n),r.updateRecordBody(e,i),r.emitUpdate(e,n)}},r.updateExtInfo=function(e,i){t.update({_id:e},{$set:{ext:i}},{},function(t,i){t||r.emitUpdate(e)})},r.appendRecord=function(e){if(e.req.headers.anyproxy_web_req)return-1;var n=e.url;if(!(n.match("/ws/target")||n.match("/ws/client/")||n.match(/localhost/i)||n.match(/client\/weinre\//))){try{var o=e.req.headers["user-agent"],a=o.indexOf("wechatdevtools");if(-1!==a)return;if(o===navigator.userAgent)return}catch(d){}var s=i++,c=normalizeInfo(s,e);return t.insert(c),r.updateRecordBody(i,e),r.emitUpdate(i,c),s}},r.updateRecordBody=function(e,t){-1!=e&&e&&t.resBody&&(/image/.test(t.resHeader["content-type"])?r.recordBodyMap[e]="(image)":r.recordBodyMap[e]=t.resBody)},r.getBody=function(e){return 0>e?"":r.recordBodyMap[e]||""},r.getBodyUTF8=function(e,t){var i=r.getBody(e),n="";GLOBAL.recorder.getSingleRecord(e,function(e,r){if(!r||!r[0])return void t(new Error("failed to find record for this id"));if(i){var o=r[0],a=o.resHeader||{};try{var d=JSON.stringify(a).match(/charset="?([a-zA-Z0-9\-]+)"?/);if(d&&d.length>1){var s=d[1].toLowerCase();"utf-8"!=s&&iconv.encodingExists(s)&&(i=iconv.decode(i,s))}}catch(c){}t(null,i.toString())}else t(null,n)})},r.getSingleRecord=function(e,r){t.find({_id:parseInt(e)},r)},r.getSummaryList=function(e){t.find({},e)},r.getRecords=function(e,r,n){r=r||10,e="number"==typeof e?e:i-r,t.find({_id:{$gte:parseInt(e)}}).limit(r).exec(n)},r.db=t}function normalizeInfo(e,t){var r={};return r._id=e,r.id=e,r.url=t.url,r.host=t.host,r.path=t.path,r.method=t.method,r.reqHeader=t.req.headers,r.startTime=t.startTime,r.reqBody=t.reqBody||"",r.protocol=t.protocol||"",t.endTime?(r.statusCode=t.statusCode,r.endTime=t.endTime,r.resHeader=t.resHeader,r.length=t.length,t.resHeader["content-type"]?r.mime=t.resHeader["content-type"].split(";")[0]:r.mime="",r.duration=t.endTime-t.startTime):(r.statusCode="",r.endTime="",r.resHeader="",r.length="",r.mime="",r.duration=""),r}var zlib=require("zlib"),Datastore=require("nedb"),util=require("util"),fs=require("fs"),events=require("events"),iconv=require("iconv-lite"),logUtil=require("./log");util.inherits(Recorder,events.EventEmitter),module.exports=Recorder;