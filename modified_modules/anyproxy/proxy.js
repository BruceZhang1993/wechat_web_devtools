"use strict";function proxyServer(e){e=e||{};var r,t,o=this,i=/https/i.test(e.type||DEFAULT_TYPE)?T_TYPE_HTTPS:T_TYPE_HTTP,l=e.port||DEFAULT_PORT,n=e.hostname||DEFAULT_HOST,s=e.rule||default_rule,u=e.webPort||DEFAULT_WEB_PORT,c=e.socketPort||DEFAULT_WEBSOCKET_PORT,p=(e.webConfigPort||DEFAULT_CONFIG_PORT,!!e.disableWebInterface),T=!!e.silent;if(T&&logUtil.setPrintStatus(!1),GLOBAL.option=e,e.dbFile?GLOBAL.recorder=new Recorder({filename:e.dbFile}):GLOBAL.recorder=new Recorder,e.interceptHttps){default_rule.setInterceptFlag(!0);var a=Number(process.version.match(/^v(\d+\.\d+)/)[1]);.12>a&&logUtil.printLog(color.red("node >= v0.12 is required when trying to intercept HTTPS requests :("),logUtil.T_ERR)}e.throttle&&(logUtil.printLog("throttle :"+e.throttle+"kb/s"),GLOBAL._throttle=new ThrottleGroup({rate:1024*parseInt(e.throttle)})),requestHandler.setRules(s),o.httpProxyServer=null,async.series([function(e){i==T_TYPE_HTTPS?certMgr.getCertificate(n,function(r,t,i){r?e(r):(o.httpProxyServer=https.createServer({key:t,cert:i},requestHandler.userRequestHandler),e(null))}):(o.httpProxyServer=http.createServer(requestHandler.userRequestHandler),e(null))},function(e){o.httpProxyServer.on("connect",requestHandler.connectReqHandler),e(null)},function(e){o.httpProxyServer.listen(l),e(null)},function(e){t=new wsServer({port:c}),e(null)},function(e){if(p)logUtil.printLog("web interface is disabled");else{var t={port:u,wsPort:c,userRule:s,ip:ip.address()};r=new webInterface(t)}e(null)},function(e){process.on("exit",function(e){logUtil.printLog("AnyProxy is about to exit with code: "+e,logUtil.T_ERR),process.exit()}),process.on("uncaughtException",function(e){}),e(null)}],function(e,r){if(e){var t="err when start proxy server :(";logUtil.printLog(color.red(t),logUtil.T_ERR),logUtil.printLog(e,logUtil.T_ERR)}else{var o,n;n="http://"+ip.address()+":"+u+"/",o="GUI interface started at : "+n,logUtil.printLog(color.green(o));var t=(i==T_TYPE_HTTP?"Http":"Https")+" proxy started at "+color.bold(ip.address()+":"+l);logUtil.printLog(color.green(t))}}),o.close=function(){o.httpProxyServer&&o.httpProxyServer.close(),logUtil.printLog(color.green("server closed :"+n+":"+l))}}try{GLOBAL.util=require("./lib/util")}catch(e){}var http=require("http"),https=require("https"),fs=require("fs"),async=require("async"),url=require("url"),program=require("commander"),color=require("colorful"),certMgr=require("./lib/certMgr"),getPort=require("./lib/getPort"),requestHandler=require("./lib/requestHandler"),Recorder=require("./lib/recorder"),logUtil=require("./lib/log"),wsServer=require("./lib/wsServer"),webInterface=require("./lib/webInterface"),inherits=require("util").inherits,util=require("./lib/util"),path=require("path"),juicer=require("juicer"),events=require("events"),express=require("express"),ip=require("ip"),ThrottleGroup=require("stream-throttle").ThrottleGroup,iconv=require("iconv-lite"),Buffer=require("buffer").Buffer,T_TYPE_HTTP=0,T_TYPE_HTTPS=1,DEFAULT_PORT=8001,DEFAULT_WEB_PORT=8002,DEFAULT_WEBSOCKET_PORT=8003,DEFAULT_CONFIG_PORT=8088,DEFAULT_HOST="localhost",DEFAULT_TYPE=T_TYPE_HTTP,default_rule=require("./lib/rule_default");module.exports.proxyServer=proxyServer,module.exports.generateRootCA=certMgr.generateRootCA,module.exports.isRootCAFileExists=certMgr.isRootCAFileExists,module.exports.setRules=requestHandler.setRules;